#!/bin/bash

# åˆ†å¸ƒå¼è¿½è¸ªæ•°æ®ç”Ÿæˆå·¥å…·
# Copyright (c) 2024 SWIT Framework Authors

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
CONFIG_FILE="$PROJECT_ROOT/scripts/config/demo-config.env"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_header() {
    echo -e "${PURPLE}[TRACE-GEN]${NC} $1"
}

# æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
show_welcome() {
    echo "======================================================================"
    echo -e "${BLUE}ğŸ¯ SWIT æ¡†æ¶åˆ†å¸ƒå¼è¿½è¸ªæ•°æ®ç”Ÿæˆå·¥å…·${NC}"
    echo "======================================================================"
    echo -e "${YELLOW}æœ¬å·¥å…·ç”¨äºç”Ÿæˆå„ç§ç±»å‹çš„è¿½è¸ªæ•°æ®ï¼š${NC}"
    echo "  ğŸ“ æ¨¡æ‹ŸçœŸå®ä¸šåŠ¡åœºæ™¯"
    echo "  ğŸ”„ ç”Ÿæˆå¤§é‡æµ‹è¯•æ•°æ®"
    echo "  âš¡ æ”¯æŒå¼‚æ­¥å¹¶å‘è¯·æ±‚"
    echo "  ğŸ² éšæœºåŒ–å‚æ•°é…ç½®"
    echo "  ğŸ“Š å®æ—¶è¿›åº¦æ˜¾ç¤º"
    echo
}

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
show_usage() {
    echo "Usage: $0 [options]"
    echo
    echo "Options:"
    echo "  -h, --help              æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
    echo "  -s, --scenario=NAME     ç”Ÿæˆåœºæ™¯ (é»˜è®¤: mixed)"
    echo "                          å¯é€‰: order, payment, inventory, mixed, error"
    echo "  -n, --count=N           ç”Ÿæˆæ•°æ®æ¡æ•° (é»˜è®¤: 100)"
    echo "  -c, --concurrency=N     å¹¶å‘åº¦ (é»˜è®¤: 5)"
    echo "  -d, --duration=SECONDS  ç”ŸæˆæŒç»­æ—¶é—´ (ä¸countäºŒé€‰ä¸€)"
    echo "  -r, --rate=RPS          ç”Ÿæˆé€Ÿç‡ (è¯·æ±‚/ç§’, é»˜è®¤: 10)"
    echo "  --min-delay=MS          æœ€å°è¯·æ±‚å»¶è¿Ÿ (æ¯«ç§’, é»˜è®¤: 100)"
    echo "  --max-delay=MS          æœ€å¤§è¯·æ±‚å»¶è¿Ÿ (æ¯«ç§’, é»˜è®¤: 1000)"
    echo "  --error-rate=PERCENT    é”™è¯¯ç‡ç™¾åˆ†æ¯” (0-100, é»˜è®¤: 5)"
    echo "  --output=FILE           è¾“å‡ºç»Ÿè®¡åˆ°æ–‡ä»¶"
    echo "  --dry-run               ä»…æ˜¾ç¤ºå°†è¦ç”Ÿæˆçš„æ•°æ®ï¼Œä¸å®é™…å‘é€"
    echo "  --verbose               è¯¦ç»†è¾“å‡º"
    echo "  --quiet                 é™é»˜æ¨¡å¼"
    echo
    echo "Scenarios:"
    echo "  order       è®¢å•åˆ›å»ºåœºæ™¯ (è®¢å•->æ”¯ä»˜->åº“å­˜)"
    echo "  payment     æ”¯ä»˜å¤„ç†åœºæ™¯"
    echo "  inventory   åº“å­˜æŸ¥è¯¢/æ›´æ–°åœºæ™¯"
    echo "  mixed       æ··åˆåœºæ™¯ (éšæœºé€‰æ‹©ä¸Šè¿°åœºæ™¯)"
    echo "  error       é”™è¯¯æ¨¡æ‹Ÿåœºæ™¯ (æ•…æ„è§¦å‘å„ç§é”™è¯¯)"
    echo
    echo "Examples:"
    echo "  $0                                  # ç”Ÿæˆ100æ¡æ··åˆåœºæ™¯æ•°æ®"
    echo "  $0 -s order -n 500 -c 10          # å¹¶å‘10ç”Ÿæˆ500æ¡è®¢å•æ•°æ®"
    echo "  $0 -d 300 -r 50 --error-rate=10   # 50RPSç”Ÿæˆ5åˆ†é’Ÿï¼Œ10%é”™è¯¯ç‡"
    echo "  $0 --dry-run -s error              # é¢„è§ˆé”™è¯¯åœºæ™¯æ•°æ®"
    echo "  $0 -s mixed --output=stats.json   # ç”Ÿæˆæ•°æ®å¹¶ä¿å­˜ç»Ÿè®¡ä¿¡æ¯"
}

# åŠ è½½é…ç½®
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        log_info "æ­£åœ¨åŠ è½½é…ç½®æ–‡ä»¶: $CONFIG_FILE"
        source "$CONFIG_FILE"
    else
        log_warning "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILEï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
    fi
    
    # é»˜è®¤é…ç½®
    ORDER_SERVICE_URL=${ORDER_SERVICE_URL:-"http://localhost:8081"}
    PAYMENT_SERVICE_URL=${PAYMENT_SERVICE_URL:-"http://localhost:8082"}
    INVENTORY_SERVICE_URL=${INVENTORY_SERVICE_URL:-"http://localhost:8083"}
}

# æ£€æŸ¥ä¾èµ–
check_dependencies() {
    local missing_tools=()
    
    for tool in curl jq bc; do
        if ! command -v $tool &> /dev/null; then
            missing_tools+=("$tool")
        fi
    done
    
    if [ ${#missing_tools[@]} -gt 0 ]; then
        log_error "ç¼ºå°‘å¿…éœ€å·¥å…·: ${missing_tools[*]}"
        echo "å®‰è£…æ–¹æ³•ï¼š"
        echo "  macOS: brew install curl jq bc"
        echo "  Ubuntu: sudo apt-get install curl jq bc"
        exit 1
    fi
}

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
check_services() {
    if [ "$DRY_RUN" = "true" ]; then
        log_info "å¹²è·‘æ¨¡å¼ï¼Œè·³è¿‡æœåŠ¡æ£€æŸ¥"
        return 0
    fi
    
    log_header "æ£€æŸ¥æœåŠ¡çŠ¶æ€"
    
    local services=(
        "$ORDER_SERVICE_URL/health:è®¢å•æœåŠ¡"
        "$PAYMENT_SERVICE_URL/health:æ”¯ä»˜æœåŠ¡"
        "$INVENTORY_SERVICE_URL/health:åº“å­˜æœåŠ¡"
    )
    
    local failed_services=()
    
    for service_info in "${services[@]}"; do
        local url="${service_info%:*}"
        local name="${service_info#*:}"
        
        if curl -f -s --connect-timeout 5 "$url" > /dev/null 2>&1; then
            log_success "$name è¿è¡Œæ­£å¸¸"
        else
            log_warning "$name æ— æ³•è®¿é—®: $url"
            failed_services+=("$name")
        fi
    done
    
    if [ ${#failed_services[@]} -gt 0 ]; then
        log_error "ä»¥ä¸‹æœåŠ¡æ— æ³•è®¿é—®: ${failed_services[*]}"
        log_info "è¯·å…ˆå¯åŠ¨æœåŠ¡: ./scripts/start.sh"
        
        if [ "$FORCE" != "true" ]; then
            exit 1
        else
            log_warning "å¼ºåˆ¶æ¨¡å¼ï¼Œç»§ç»­æ‰§è¡Œï¼ˆå¯èƒ½å¯¼è‡´é”™è¯¯ï¼‰"
        fi
    fi
    
    log_success "æœåŠ¡æ£€æŸ¥å®Œæˆ"
}

# ç”Ÿæˆæµ‹è¯•æ•°æ®
generate_test_data() {
    # åˆ›å»ºæµ‹è¯•ç”¨çš„å®¢æˆ·å’Œäº§å“æ•°æ®
    cat << 'EOF'
{
    "customers": [
        {"id": "customer-001", "name": "å¼ ä¸‰", "email": "zhangsan@example.com", "phone": "13800138001"},
        {"id": "customer-002", "name": "æå››", "email": "lisi@example.com", "phone": "13800138002"},
        {"id": "customer-003", "name": "ç‹äº”", "email": "wangwu@example.com", "phone": "13800138003"},
        {"id": "customer-004", "name": "èµµå…­", "email": "zhaoliu@example.com", "phone": "13800138004"},
        {"id": "customer-005", "name": "å­™ä¸ƒ", "email": "sunqi@example.com", "phone": "13800138005"},
        {"id": "customer-006", "name": "å‘¨å…«", "email": "zhouba@example.com", "phone": "13800138006"},
        {"id": "customer-007", "name": "å´ä¹", "email": "wujiu@example.com", "phone": "13800138007"},
        {"id": "customer-008", "name": "éƒ‘å", "email": "zhengshi@example.com", "phone": "13800138008"}
    ],
    "products": [
        {"id": "product-001", "name": "ç¬”è®°æœ¬ç”µè„‘", "price": 5999.99, "stock": 100, "category": "electronics"},
        {"id": "product-002", "name": "æ™ºèƒ½æ‰‹æœº", "price": 2999.99, "stock": 200, "category": "electronics"},
        {"id": "product-003", "name": "æ— çº¿è€³æœº", "price": 299.99, "stock": 500, "category": "electronics"},
        {"id": "product-004", "name": "å’–å•¡è±†", "price": 89.99, "stock": 1000, "category": "food"},
        {"id": "product-005", "name": "ä¿æ¸©æ¯", "price": 129.99, "stock": 300, "category": "household"},
        {"id": "product-006", "name": "è¿åŠ¨é‹", "price": 699.99, "stock": 150, "category": "clothing"},
        {"id": "product-007", "name": "å›¾ä¹¦", "price": 49.99, "stock": 800, "category": "books"},
        {"id": "product-008", "name": "æŠ¤è‚¤å“", "price": 199.99, "stock": 400, "category": "beauty"}
    ]
}
EOF
}

# ç”Ÿæˆè®¢å•æ•°æ®
generate_order_request() {
    local customer_id="$1"
    local product_id="$2"
    local quantity="$3"
    local should_error="$4"
    
    if [ "$should_error" = "true" ]; then
        # æ•…æ„ç”Ÿæˆä¼šå¯¼è‡´é”™è¯¯çš„æ•°æ®
        case $((RANDOM % 3)) in
            0) customer_id="invalid-customer" ;;
            1) product_id="invalid-product" ;;
            2) quantity=0 ;;
        esac
    fi
    
    local amount=$(echo "$quantity * 99.99" | bc -l)
    
    cat << EOF
{
    "customer_id": "$customer_id",
    "product_id": "$product_id", 
    "quantity": $quantity,
    "amount": $amount,
    "source": "trace-generator",
    "timestamp": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
}
EOF
}

# ç”Ÿæˆæ”¯ä»˜æ•°æ®
generate_payment_request() {
    local customer_id="$1"
    local amount="$2"
    local should_error="$3"
    
    if [ "$should_error" = "true" ]; then
        # æ•…æ„ç”Ÿæˆä¼šå¯¼è‡´æ”¯ä»˜å¤±è´¥çš„æ•°æ®
        case $((RANDOM % 2)) in
            0) amount="-1" ;;
            1) customer_id="blocked-customer" ;;
        esac
    fi
    
    cat << EOF
{
    "customer_id": "$customer_id",
    "amount": $amount,
    "payment_method": "credit_card",
    "currency": "CNY",
    "description": "ç”±è¿½è¸ªç”Ÿæˆå™¨ç”Ÿæˆçš„æµ‹è¯•æ”¯ä»˜",
    "timestamp": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
}
EOF
}

# ç”Ÿæˆåº“å­˜æŸ¥è¯¢/æ›´æ–°æ•°æ®
generate_inventory_request() {
    local product_id="$1"
    local operation="$2"
    local quantity="$3"
    local should_error="$4"
    
    if [ "$should_error" = "true" ]; then
        case $((RANDOM % 2)) in
            0) product_id="nonexistent-product" ;;
            1) quantity="99999" ;;  # åº“å­˜ä¸è¶³
        esac
    fi
    
    case "$operation" in
        "check")
            cat << EOF
{
    "product_id": "$product_id",
    "operation": "check",
    "timestamp": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
}
EOF
            ;;
        "reserve")
            cat << EOF
{
    "product_id": "$product_id",
    "operation": "reserve",
    "quantity": $quantity,
    "timestamp": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')"
}
EOF
            ;;
    esac
}

# å‘é€è¯·æ±‚
send_request() {
    local method="$1"
    local url="$2"
    local data="$3"
    local request_id="$4"
    
    if [ "$DRY_RUN" = "true" ]; then
        if [ "$VERBOSE" = "true" ]; then
            echo "[$request_id] æ¨¡æ‹Ÿè¯·æ±‚: $method $url"
            echo "æ•°æ®: $data"
        fi
        return 0
    fi
    
    local start_time=$(date +%s%3N)
    local response_code
    
    if [ "$method" = "POST" ]; then
        response_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "X-Request-ID: $request_id" \
            -d "$data" \
            --connect-timeout 10 \
            --max-time 30 \
            "$url" 2>/dev/null || echo "000")
    else
        response_code=$(curl -s -o /dev/null -w "%{http_code}" \
            -X GET \
            -H "X-Request-ID: $request_id" \
            --connect-timeout 10 \
            --max-time 30 \
            "$url" 2>/dev/null || echo "000")
    fi
    
    local end_time=$(date +%s%3N)
    local duration=$((end_time - start_time))
    
    # æ›´æ–°ç»Ÿè®¡
    if [[ "$response_code" =~ ^2[0-9][0-9]$ ]]; then
        ((STATS_SUCCESS++))
    else
        ((STATS_ERROR++))
    fi
    
    ((STATS_TOTAL++))
    STATS_TOTAL_DURATION=$((STATS_TOTAL_DURATION + duration))
    
    if [ "$VERBOSE" = "true" ]; then
        echo "[$request_id] $method $url -> $response_code (${duration}ms)"
    fi
    
    return 0
}

# ç”Ÿæˆè®¢å•åœºæ™¯
generate_order_scenario() {
    local should_error="$1"
    local request_id="trace-gen-$(date +%s)-$RANDOM"
    
    local test_data
    test_data=$(generate_test_data)
    
    # éšæœºé€‰æ‹©å®¢æˆ·å’Œäº§å“
    local customers=($(echo "$test_data" | jq -r '.customers[].id'))
    local products=($(echo "$test_data" | jq -r '.products[].id'))
    
    local customer_id=${customers[$RANDOM % ${#customers[@]}]}
    local product_id=${products[$RANDOM % ${#products[@]}]}
    local quantity=$((RANDOM % 5 + 1))
    
    # 1. åˆ›å»ºè®¢å•
    local order_data
    order_data=$(generate_order_request "$customer_id" "$product_id" "$quantity" "$should_error")
    send_request "POST" "$ORDER_SERVICE_URL/api/v1/orders" "$order_data" "$request_id"
    
    # éšæœºå»¶è¿Ÿæ¨¡æ‹ŸçœŸå®åœºæ™¯
    local delay=$((RANDOM % (MAX_DELAY - MIN_DELAY + 1) + MIN_DELAY))
    sleep $(echo "scale=3; $delay / 1000" | bc)
}

# ç”Ÿæˆæ”¯ä»˜åœºæ™¯
generate_payment_scenario() {
    local should_error="$1"
    local request_id="trace-gen-$(date +%s)-$RANDOM"
    
    local test_data
    test_data=$(generate_test_data)
    
    local customers=($(echo "$test_data" | jq -r '.customers[].id'))
    local customer_id=${customers[$RANDOM % ${#customers[@]}]}
    local amount=$(echo "scale=2; $RANDOM * 0.01 + 10" | bc)
    
    local payment_data
    payment_data=$(generate_payment_request "$customer_id" "$amount" "$should_error")
    send_request "POST" "$PAYMENT_SERVICE_URL/api/v1/payments" "$payment_data" "$request_id"
    
    local delay=$((RANDOM % (MAX_DELAY - MIN_DELAY + 1) + MIN_DELAY))
    sleep $(echo "scale=3; $delay / 1000" | bc)
}

# ç”Ÿæˆåº“å­˜åœºæ™¯
generate_inventory_scenario() {
    local should_error="$1"
    local request_id="trace-gen-$(date +%s)-$RANDOM"
    
    local test_data
    test_data=$(generate_test_data)
    
    local products=($(echo "$test_data" | jq -r '.products[].id'))
    local product_id=${products[$RANDOM % ${#products[@]}]}
    local operation="check"
    
    # éšæœºé€‰æ‹©æ“ä½œç±»å‹
    if [ $((RANDOM % 2)) -eq 0 ]; then
        operation="reserve"
    fi
    
    local quantity=$((RANDOM % 10 + 1))
    
    if [ "$operation" = "check" ]; then
        send_request "GET" "$INVENTORY_SERVICE_URL/api/v1/inventory/$product_id" "" "$request_id"
    else
        local inventory_data
        inventory_data=$(generate_inventory_request "$product_id" "$operation" "$quantity" "$should_error")
        send_request "POST" "$INVENTORY_SERVICE_URL/api/v1/inventory/reserve" "$inventory_data" "$request_id"
    fi
    
    local delay=$((RANDOM % (MAX_DELAY - MIN_DELAY + 1) + MIN_DELAY))
    sleep $(echo "scale=3; $delay / 1000" | bc)
}

# ç”Ÿæˆæ··åˆåœºæ™¯
generate_mixed_scenario() {
    local should_error="$1"
    
    case $((RANDOM % 3)) in
        0) generate_order_scenario "$should_error" ;;
        1) generate_payment_scenario "$should_error" ;;
        2) generate_inventory_scenario "$should_error" ;;
    esac
}

# æ˜¾ç¤ºè¿›åº¦
show_progress() {
    if [ "$QUIET" = "true" ]; then
        return 0
    fi
    
    local current="$1"
    local total="$2"
    local start_time="$3"
    
    local percent=$((current * 100 / total))
    local elapsed=$(($(date +%s) - start_time))
    
    local avg_duration=0
    if [ $STATS_TOTAL -gt 0 ]; then
        avg_duration=$((STATS_TOTAL_DURATION / STATS_TOTAL))
    fi
    
    local success_rate=0
    if [ $STATS_TOTAL -gt 0 ]; then
        success_rate=$(echo "scale=1; $STATS_SUCCESS * 100 / $STATS_TOTAL" | bc)
    fi
    
    printf "\rè¿›åº¦: %d/%d (%d%%) | ç”¨æ—¶: %ds | æˆåŠŸç‡: %s%% | å¹³å‡å»¶è¿Ÿ: %dms" \
        "$current" "$total" "$percent" "$elapsed" "$success_rate" "$avg_duration"
}

# ç”Ÿæˆè¿½è¸ªæ•°æ®
generate_traces() {
    log_header "å¼€å§‹ç”Ÿæˆè¿½è¸ªæ•°æ®"
    
    # åˆå§‹åŒ–ç»Ÿè®¡
    STATS_TOTAL=0
    STATS_SUCCESS=0
    STATS_ERROR=0
    STATS_TOTAL_DURATION=0
    
    local start_time=$(date +%s)
    local generated_count=0
    
    if [ -n "$DURATION" ]; then
        # æŒ‰æ—¶é—´ç”Ÿæˆ
        log_info "åœºæ™¯: $SCENARIO | æŒç»­æ—¶é—´: ${DURATION}ç§’ | é€Ÿç‡: ${RATE}RPS | å¹¶å‘: $CONCURRENCY"
        
        local end_time=$((start_time + DURATION))
        local interval=$(echo "scale=3; 1 / $RATE" | bc)
        
        while [ $(date +%s) -lt $end_time ]; do
            for ((i=0; i<CONCURRENCY; i++)); do
                local should_error="false"
                if [ $((RANDOM % 100)) -lt $ERROR_RATE ]; then
                    should_error="true"
                fi
                
                case "$SCENARIO" in
                    "order") generate_order_scenario "$should_error" & ;;
                    "payment") generate_payment_scenario "$should_error" & ;;
                    "inventory") generate_inventory_scenario "$should_error" & ;;
                    "mixed") generate_mixed_scenario "$should_error" & ;;
                    "error") generate_mixed_scenario "true" & ;;
                esac
                
                ((generated_count++))
            done
            
            # ç­‰å¾…å¹¶å‘è¯·æ±‚å®Œæˆ
            wait
            
            show_progress $generated_count $((DURATION * RATE)) $start_time
            
            sleep "$interval"
        done
    else
        # æŒ‰æ•°é‡ç”Ÿæˆ
        log_info "åœºæ™¯: $SCENARIO | æ•°é‡: $COUNT | å¹¶å‘: $CONCURRENCY | é”™è¯¯ç‡: ${ERROR_RATE}%"
        
        for ((i=1; i<=COUNT; i+=CONCURRENCY)); do
            for ((j=0; j<CONCURRENCY && i+j<=COUNT; j++)); do
                local should_error="false"
                if [ $((RANDOM % 100)) -lt $ERROR_RATE ]; then
                    should_error="true"
                fi
                
                case "$SCENARIO" in
                    "order") generate_order_scenario "$should_error" & ;;
                    "payment") generate_payment_scenario "$should_error" & ;;
                    "inventory") generate_inventory_scenario "$should_error" & ;;
                    "mixed") generate_mixed_scenario "$should_error" & ;;
                    "error") generate_mixed_scenario "true" & ;;
                esac
                
                ((generated_count++))
            done
            
            # ç­‰å¾…å½“å‰æ‰¹æ¬¡å®Œæˆ
            wait
            
            show_progress $generated_count $COUNT $start_time
        done
    fi
    
    echo  # æ¢è¡Œ
    
    local end_time=$(date +%s)
    local total_time=$((end_time - start_time))
    
    log_success "è¿½è¸ªæ•°æ®ç”Ÿæˆå®Œæˆ"
    
    # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    log_header "ç”Ÿæˆç»Ÿè®¡"
    echo "  æ€»è¯·æ±‚æ•°: $STATS_TOTAL"
    echo "  æˆåŠŸè¯·æ±‚: $STATS_SUCCESS"
    echo "  å¤±è´¥è¯·æ±‚: $STATS_ERROR"
    if [ $STATS_TOTAL -gt 0 ]; then
        echo "  æˆåŠŸç‡: $(echo "scale=2; $STATS_SUCCESS * 100 / $STATS_TOTAL" | bc)%"
    else
        echo "  æˆåŠŸç‡: N/A"
    fi
    echo "  æ€»ç”¨æ—¶: ${total_time}ç§’"
    if [ $total_time -gt 0 ]; then
        echo "  å¹³å‡RPS: $(echo "scale=2; $STATS_TOTAL / $total_time" | bc)"
    else
        echo "  å¹³å‡RPS: N/A"
    fi
    if [ $STATS_TOTAL -gt 0 ]; then
        echo "  å¹³å‡å»¶è¿Ÿ: $((STATS_TOTAL_DURATION / STATS_TOTAL))ms"
    fi
    
    # ä¿å­˜ç»Ÿè®¡ä¿¡æ¯
    if [ -n "$OUTPUT_FILE" ]; then
        local stats_json=$(cat << EOF
{
    "generated_at": "$(date -u '+%Y-%m-%dT%H:%M:%SZ')",
    "scenario": "$SCENARIO",
    "parameters": {
        "count": $COUNT,
        "duration": $DURATION,
        "concurrency": $CONCURRENCY,
        "rate": $RATE,
        "error_rate": $ERROR_RATE,
        "min_delay": $MIN_DELAY,
        "max_delay": $MAX_DELAY
    },
    "results": {
        "total_requests": $STATS_TOTAL,
        "successful_requests": $STATS_SUCCESS,
        "failed_requests": $STATS_ERROR,
        "success_rate": $(
            if [ "$STATS_TOTAL" -eq 0 ]; then
                echo "0"
            else
                echo "scale=4; $STATS_SUCCESS * 100 / $STATS_TOTAL" | bc
            fi
        ),
        "total_duration_seconds": $total_time,
        "average_rps": $(
            if [ "$total_time" -eq 0 ]; then
                echo "0"
            else
                echo "scale=4; $STATS_TOTAL / $total_time" | bc
            fi
        ),
        "average_latency_ms": $(
            if [ "$STATS_TOTAL" -eq 0 ]; then
                echo "0"
            else
                echo $(($STATS_TOTAL_DURATION / $STATS_TOTAL))
            fi
        )
    }
}
EOF
        )
        
        echo "$stats_json" > "$OUTPUT_FILE"
        log_info "ç»Ÿè®¡ä¿¡æ¯å·²ä¿å­˜åˆ°: $OUTPUT_FILE"
    fi
}

# ä¸»å‡½æ•°
main() {
    # é»˜è®¤å‚æ•°
    SCENARIO="mixed"
    COUNT=100
    CONCURRENCY=5
    DURATION=""
    RATE=10
    MIN_DELAY=100
    MAX_DELAY=1000
    ERROR_RATE=5
    OUTPUT_FILE=""
    DRY_RUN="false"
    VERBOSE="false"
    QUIET="false"
    FORCE="false"
    
    # è§£æå‘½ä»¤è¡Œå‚æ•°
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_usage
                exit 0
                ;;
            -s|--scenario)
                SCENARIO="$2"
                shift 2
                ;;
            --scenario=*)
                SCENARIO="${1#*=}"
                shift
                ;;
            -n|--count)
                COUNT="$2"
                shift 2
                ;;
            --count=*)
                COUNT="${1#*=}"
                shift
                ;;
            -c|--concurrency)
                CONCURRENCY="$2"
                shift 2
                ;;
            --concurrency=*)
                CONCURRENCY="${1#*=}"
                shift
                ;;
            -d|--duration)
                DURATION="$2"
                shift 2
                ;;
            --duration=*)
                DURATION="${1#*=}"
                shift
                ;;
            -r|--rate)
                RATE="$2"
                shift 2
                ;;
            --rate=*)
                RATE="${1#*=}"
                shift
                ;;
            --min-delay=*)
                MIN_DELAY="${1#*=}"
                shift
                ;;
            --max-delay=*)
                MAX_DELAY="${1#*=}"
                shift
                ;;
            --error-rate=*)
                ERROR_RATE="${1#*=}"
                shift
                ;;
            --output=*)
                OUTPUT_FILE="${1#*=}"
                shift
                ;;
            --dry-run)
                DRY_RUN="true"
                shift
                ;;
            --verbose)
                VERBOSE="true"
                shift
                ;;
            --quiet)
                QUIET="true"
                shift
                ;;
            --force)
                FORCE="true"
                shift
                ;;
            *)
                log_error "æœªçŸ¥é€‰é¡¹: $1"
                show_usage
                exit 1
                ;;
        esac
    done
    
    # éªŒè¯å‚æ•°
    if [[ ! "$SCENARIO" =~ ^(order|payment|inventory|mixed|error)$ ]]; then
        log_error "æ— æ•ˆçš„åœºæ™¯ç±»å‹: $SCENARIO"
        log_info "æ”¯æŒçš„åœºæ™¯: order, payment, inventory, mixed, error"
        exit 1
    fi
    
    if [ $ERROR_RATE -lt 0 ] || [ $ERROR_RATE -gt 100 ]; then
        log_error "é”™è¯¯ç‡å¿…é¡»åœ¨0-100ä¹‹é—´: $ERROR_RATE"
        exit 1
    fi
    
    if [ $MIN_DELAY -gt $MAX_DELAY ]; then
        log_error "æœ€å°å»¶è¿Ÿä¸èƒ½å¤§äºæœ€å¤§å»¶è¿Ÿ"
        exit 1
    fi
    
    if [ "$QUIET" != "true" ]; then
        show_welcome
    fi
    
    load_config
    check_dependencies
    check_services
    
    if [ "$DRY_RUN" = "true" ]; then
        log_info "å¹²è·‘æ¨¡å¼ï¼Œä»…æ˜¾ç¤ºé¢„è§ˆä¿¡æ¯"
    fi
    
    generate_traces
    
    if [ "$QUIET" != "true" ]; then
        echo
        log_success "è¿½è¸ªæ•°æ®ç”Ÿæˆå·¥å…·æ‰§è¡Œå®Œæˆï¼"
    fi
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"