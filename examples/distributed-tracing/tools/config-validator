#!/bin/bash

# é…ç½®éªŒè¯å·¥å…·
# Copyright (c) 2024 SWIT Framework Authors

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_header() {
    echo -e "${PURPLE}[CONFIG-VALIDATOR]${NC} $1"
}

# æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
show_welcome() {
    echo "======================================================================"
    echo -e "${BLUE}ğŸ”§ SWIT æ¡†æ¶åˆ†å¸ƒå¼è¿½è¸ªé…ç½®éªŒè¯å·¥å…·${NC}"
    echo "======================================================================"
    echo -e "${YELLOW}æœ¬å·¥å…·ç”¨äºéªŒè¯åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿçš„é…ç½®ï¼š${NC}"
    echo "  ğŸ“ é…ç½®æ–‡ä»¶æ ¼å¼éªŒè¯"
    echo "  ğŸ” å‚æ•°å®Œæ•´æ€§æ£€æŸ¥"
    echo "  âš¡ ç«¯å£å ç”¨æ£€æµ‹"
    echo "  ğŸŒ æœåŠ¡è¿æ¥æµ‹è¯•"
    echo "  ğŸ“Š é…ç½®å»ºè®®å’Œä¼˜åŒ–"
    echo
}

# æ˜¾ç¤ºä½¿ç”¨è¯´æ˜
show_usage() {
    echo "Usage: $0 [options] [config-files...]"
    echo
    echo "Options:"
    echo "  -h, --help              æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
    echo "  -f, --file=FILE         æŒ‡å®šé…ç½®æ–‡ä»¶ (å¯å¤šæ¬¡ä½¿ç”¨)"
    echo "  -t, --type=TYPE         é…ç½®ç±»å‹ (é»˜è®¤: auto)"
    echo "                          å¯é€‰: docker-compose, env, yaml, json, all, auto"
    echo "  -c, --check=CHECKS      æŒ‡å®šæ£€æŸ¥é¡¹ (é»˜è®¤: all)"
    echo "                          å¯é€‰: syntax, completeness, connectivity, security, performance, all"
    echo "  -o, --output=FORMAT     è¾“å‡ºæ ¼å¼ (é»˜è®¤: text)"
    echo "                          å¯é€‰: text, json, html"
    echo "  --fix                   è‡ªåŠ¨ä¿®å¤å¯ä¿®å¤çš„é—®é¢˜"
    echo "  --strict                ä¸¥æ ¼æ¨¡å¼ (ä»»ä½•è­¦å‘Šéƒ½è§†ä¸ºé”™è¯¯)"
    echo "  --output-file=FILE      è¾“å‡ºç»“æœåˆ°æ–‡ä»¶"
    echo "  --verbose               è¯¦ç»†è¾“å‡º"
    echo "  --quiet                 åªè¾“å‡ºé”™è¯¯"
    echo
    echo "Config Types:"
    echo "  docker-compose    Docker Compose YAML æ–‡ä»¶"
    echo "  env              ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶"
    echo "  yaml             YAML é…ç½®æ–‡ä»¶"
    echo "  json             JSON é…ç½®æ–‡ä»¶" 
    echo "  all              æ£€æŸ¥æ‰€æœ‰æ”¯æŒç±»å‹"
    echo "  auto             è‡ªåŠ¨æ£€æµ‹ç±»å‹"
    echo
    echo "Check Types:"
    echo "  syntax           é…ç½®æ–‡ä»¶è¯­æ³•æ£€æŸ¥"
    echo "  completeness     å¿…éœ€å‚æ•°å®Œæ•´æ€§æ£€æŸ¥"
    echo "  connectivity     æœåŠ¡è¿æ¥æ€§æ£€æŸ¥"
    echo "  security         å®‰å…¨é…ç½®æ£€æŸ¥"
    echo "  performance      æ€§èƒ½é…ç½®æ£€æŸ¥"
    echo "  all              æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥"
    echo
    echo "Examples:"
    echo "  $0                                    # éªŒè¯é»˜è®¤é…ç½®æ–‡ä»¶"
    echo "  $0 -f docker-compose.yml             # éªŒè¯æŒ‡å®šæ–‡ä»¶"
    echo "  $0 -t env -c connectivity            # éªŒè¯ç¯å¢ƒé…ç½®çš„è¿æ¥æ€§"
    echo "  $0 --fix --output=json               # ä¿®å¤é—®é¢˜å¹¶è¾“å‡ºJSONæ ¼å¼ç»“æœ"
    echo "  $0 -c security --strict              # ä¸¥æ ¼å®‰å…¨æ£€æŸ¥"
}

# æ£€æŸ¥ä¾èµ–å·¥å…·
check_dependencies() {
    local missing_tools=()
    local optional_missing=()
    
    # åŸºç¡€å·¥å…·
    for tool in jq yq; do
        if ! command -v $tool &> /dev/null; then
            missing_tools+=("$tool")
        fi
    done
    
    # å¯é€‰å·¥å…·
    for tool in yamllint shellcheck; do
        if ! command -v $tool &> /dev/null; then
            optional_missing+=("$tool")
        fi
    done
    
    if [ ${#missing_tools[@]} -gt 0 ]; then
        log_error "ç¼ºå°‘å¿…éœ€å·¥å…·: ${missing_tools[*]}"
        echo "å®‰è£…æ–¹æ³•ï¼š"
        echo "  macOS: brew install jq yq"
        echo "  Ubuntu: sudo apt-get install jq && sudo snap install yq"
        exit 1
    fi
    
    if [ ${#optional_missing[@]} -gt 0 ] && [ "$VERBOSE" = "true" ]; then
        log_warning "ç¼ºå°‘å¯é€‰å·¥å…·: ${optional_missing[*]}"
        log_info "å®‰è£…è¿™äº›å·¥å…·å¯ä»¥æä¾›æ›´å…¨é¢çš„éªŒè¯"
    fi
}

# è‡ªåŠ¨å‘ç°é…ç½®æ–‡ä»¶
discover_config_files() {
    log_header "å‘ç°é…ç½®æ–‡ä»¶"
    
    local config_files=()
    
    # Docker Compose æ–‡ä»¶
    for file in "$PROJECT_ROOT/docker-compose.yml" "$PROJECT_ROOT/docker-compose.yaml"; do
        if [ -f "$file" ]; then
            config_files+=("$file:docker-compose")
            log_info "å‘ç° Docker Compose æ–‡ä»¶: $file"
        fi
    done
    
    # ç¯å¢ƒé…ç½®æ–‡ä»¶
    for pattern in "*.env" "*config.env" "scripts/config/*.env"; do
        for file in $PROJECT_ROOT/$pattern; do
            if [ -f "$file" ]; then
                config_files+=("$file:env")
                log_info "å‘ç°ç¯å¢ƒé…ç½®æ–‡ä»¶: $file"
            fi
        done
    done
    
    # YAML é…ç½®æ–‡ä»¶
    for pattern in "*.yml" "*.yaml" "config/*.yml" "config/*.yaml" "jaeger/config/*.yml"; do
        for file in $PROJECT_ROOT/$pattern; do
            if [ -f "$file" ] && [[ "$file" != *"docker-compose"* ]]; then
                config_files+=("$file:yaml")
                log_info "å‘ç° YAML é…ç½®æ–‡ä»¶: $file"
            fi
        done
    done
    
    # JSON é…ç½®æ–‡ä»¶
    for pattern in "*.json" "config/*.json"; do
        for file in $PROJECT_ROOT/$pattern; do
            if [ -f "$file" ]; then
                config_files+=("$file:json")
                log_info "å‘ç° JSON é…ç½®æ–‡ä»¶: $file"
            fi
        done
    done
    
    if [ ${#config_files[@]} -eq 0 ]; then
        log_warning "æœªå‘ç°ä»»ä½•é…ç½®æ–‡ä»¶"
        return 1
    fi
    
    printf '%s\n' "${config_files[@]}"
}

# æ£€æµ‹é…ç½®æ–‡ä»¶ç±»å‹
detect_config_type() {
    local file="$1"
    
    case "${file##*.}" in
        "yml"|"yaml")
            if grep -q "version:" "$file" && grep -q "services:" "$file"; then
                echo "docker-compose"
            else
                echo "yaml"
            fi
            ;;
        "json") echo "json" ;;
        "env") echo "env" ;;
        *)
            if grep -q "=" "$file" && ! grep -q "{" "$file"; then
                echo "env"
            else
                echo "unknown"
            fi
            ;;
    esac
}

# éªŒè¯è¯­æ³•
validate_syntax() {
    local file="$1"
    local type="$2"
    local errors=()
    
    case "$type" in
        "docker-compose"|"yaml")
            if command -v yamllint &> /dev/null; then
                local yamllint_result
                if ! yamllint_result=$(yamllint -d "{extends: default, rules: {line-length: {max: 120}}}" "$file" 2>&1); then
                    errors+=("YAML è¯­æ³•é”™è¯¯: $yamllint_result")
                fi
            else
                # ä½¿ç”¨ yq è¿›è¡ŒåŸºç¡€è¯­æ³•æ£€æŸ¥
                if ! yq eval '.' "$file" >/dev/null 2>&1; then
                    errors+=("YAML è¯­æ³•é”™è¯¯: æ–‡ä»¶æ ¼å¼æ— æ•ˆ")
                fi
            fi
            ;;
        "json")
            if ! jq '.' "$file" >/dev/null 2>&1; then
                errors+=("JSON è¯­æ³•é”™è¯¯: æ–‡ä»¶æ ¼å¼æ— æ•ˆ")
            fi
            ;;
        "env")
            # æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶æ ¼å¼
            local line_num=0
            while IFS= read -r line; do
                ((line_num++))
                # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
                if [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]]; then
                    continue
                fi
                # æ£€æŸ¥å˜é‡æ ¼å¼
                if ! [[ "$line" =~ ^[A-Z_][A-Z0-9_]*=.* ]]; then
                    errors+=("ç¯å¢ƒå˜é‡è¯­æ³•é”™è¯¯: ç¬¬${line_num}è¡Œæ ¼å¼æ— æ•ˆ: $line")
                fi
            done < "$file"
            ;;
    esac
    
    printf '%s\n' "${errors[@]}"
}

# éªŒè¯å®Œæ•´æ€§
validate_completeness() {
    local file="$1"
    local type="$2"
    local warnings=()
    local errors=()
    
    case "$type" in
        "docker-compose")
            # æ£€æŸ¥å¿…éœ€çš„æœåŠ¡
            local required_services=("jaeger" "order-service" "payment-service" "inventory-service")
            for service in "${required_services[@]}"; do
                if ! yq eval ".services | has(\"$service\")" "$file" | grep -q "true"; then
                    warnings+=("ç¼ºå°‘æ¨èæœåŠ¡: $service")
                fi
            done
            
            # æ£€æŸ¥ç½‘ç»œé…ç½®
            if ! yq eval '.networks | length' "$file" | grep -q "[1-9]"; then
                warnings+=("å»ºè®®é…ç½®è‡ªå®šä¹‰ç½‘ç»œä»¥æ”¹å–„æœåŠ¡é—´é€šä¿¡")
            fi
            
            # æ£€æŸ¥ç«¯å£é…ç½®
            local ports_check
            ports_check=$(yq eval '.services[].ports[]?' "$file" 2>/dev/null | grep -E "^[0-9]+:" | wc -l)
            if [ "$ports_check" -eq 0 ]; then
                warnings+=("æœªæ‰¾åˆ°ç«¯å£æ˜ å°„é…ç½®")
            fi
            ;;
        "env")
            # æ£€æŸ¥å…³é”®ç¯å¢ƒå˜é‡
            local required_vars=(
                "JAEGER_UI_PORT"
                "ORDER_SERVICE_PORT" 
                "PAYMENT_SERVICE_PORT"
                "INVENTORY_SERVICE_PORT"
            )
            
            for var in "${required_vars[@]}"; do
                if ! grep -q "^$var=" "$file"; then
                    warnings+=("ç¼ºå°‘æ¨èç¯å¢ƒå˜é‡: $var")
                fi
            done
            
            # æ£€æŸ¥ç«¯å£å†²çª
            local ports=($(grep -o '[0-9]\{4,5\}' "$file" | sort | uniq))
            local seen_ports=()
            for port in "${ports[@]}"; do
                if [[ " ${seen_ports[*]} " =~ " ${port} " ]]; then
                    errors+=("ç«¯å£å†²çª: $port è¢«å¤šæ¬¡ä½¿ç”¨")
                else
                    seen_ports+=("$port")
                fi
            done
            ;;
        "yaml"|"json")
            # é€šç”¨é…ç½®æ£€æŸ¥
            local config_content
            if [ "$type" = "yaml" ]; then
                config_content=$(yq eval -o=json '.' "$file")
            else
                config_content=$(cat "$file")
            fi
            
            # æ£€æŸ¥ Jaeger é…ç½®
            if echo "$config_content" | jq -e '.jaeger' >/dev/null 2>&1; then
                if ! echo "$config_content" | jq -e '.jaeger.endpoint' >/dev/null 2>&1; then
                    warnings+=("Jaeger é…ç½®ç¼ºå°‘ endpoint")
                fi
            fi
            
            # æ£€æŸ¥æœåŠ¡é…ç½®
            if echo "$config_content" | jq -e '.services' >/dev/null 2>&1; then
                local service_count
                service_count=$(echo "$config_content" | jq '.services | length')
                if [ "$service_count" -eq 0 ]; then
                    warnings+=("æœåŠ¡é…ç½®ä¸ºç©º")
                fi
            fi
            ;;
    esac
    
    # è¾“å‡ºç»“æœ
    printf 'ERRORS:\n'
    printf '%s\n' "${errors[@]}"
    printf 'WARNINGS:\n'
    printf '%s\n' "${warnings[@]}"
}

# éªŒè¯è¿æ¥æ€§
validate_connectivity() {
    local file="$1"
    local type="$2"
    local errors=()
    local warnings=()
    
    # æå–ç«¯å£ä¿¡æ¯
    local ports=()
    case "$type" in
        "docker-compose")
            ports=($(yq eval '.services[].ports[]?' "$file" 2>/dev/null | grep -oE '^[0-9]+' | sort -u))
            ;;
        "env")
            ports=($(grep -oE '[0-9]{4,5}' "$file" | sort -u))
            ;;
        "yaml")
            local yaml_content
            yaml_content=$(yq eval -o=json '.' "$file")
            ports=($(echo "$yaml_content" | jq -r '.. | select(type == "object") | .. | select(type == "number" and . > 1000 and . < 65536)' 2>/dev/null | sort -u))
            ;;
        "json")
            ports=($(jq -r '.. | select(type == "number" and . > 1000 and . < 65536)' "$file" 2>/dev/null | sort -u))
            ;;
    esac
    
    # æ£€æŸ¥ç«¯å£å ç”¨
    for port in "${ports[@]}"; do
        if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1; then
            local process_info
            process_info=$(lsof -Pi :$port -sTCP:LISTEN | tail -n +2 | awk '{print $1}' | head -n 1)
            warnings+=("ç«¯å£ $port å·²è¢«å ç”¨ (è¿›ç¨‹: $process_info)")
        fi
    done
    
    # æ£€æŸ¥æœåŠ¡å¯è¾¾æ€§ (ä»…å½“æœåŠ¡åœ¨è¿è¡Œæ—¶)
    local service_urls=(
        "http://localhost:16686:Jaeger UI"
        "http://localhost:8081/health:Order Service"
        "http://localhost:8082/health:Payment Service" 
        "http://localhost:8083/health:Inventory Service"
    )
    
    for service_info in "${service_urls[@]}"; do
        local url="${service_info%:*}"
        local name="${service_info#*:}"
        
        if curl -f -s --connect-timeout 5 "$url" >/dev/null 2>&1; then
            log_success "$name è¿æ¥æ­£å¸¸"
        else
            warnings+=("$name ä¸å¯è¾¾: $url")
        fi
    done
    
    # è¾“å‡ºç»“æœ
    printf 'ERRORS:\n'
    printf '%s\n' "${errors[@]}"
    printf 'WARNINGS:\n'
    printf '%s\n' "${warnings[@]}"
}

# éªŒè¯å®‰å…¨æ€§
validate_security() {
    local file="$1"
    local type="$2"
    local warnings=()
    local errors=()
    
    case "$type" in
        "docker-compose")
            # æ£€æŸ¥ç‰¹æƒæ¨¡å¼
            if yq eval '.services[].privileged' "$file" 2>/dev/null | grep -q "true"; then
                warnings+=("å‘ç°ç‰¹æƒæ¨¡å¼é…ç½®ï¼Œå­˜åœ¨å®‰å…¨é£é™©")
            fi
            
            # æ£€æŸ¥ç½‘ç»œæ¨¡å¼
            if yq eval '.services[].network_mode' "$file" 2>/dev/null | grep -q "host"; then
                warnings+=("ä½¿ç”¨ host ç½‘ç»œæ¨¡å¼å¯èƒ½å­˜åœ¨å®‰å…¨é£é™©")
            fi
            
            # æ£€æŸ¥å·æŒ‚è½½
            local sensitive_mounts
            sensitive_mounts=$(yq eval '.services[].volumes[]?' "$file" 2>/dev/null | grep -E '(^/:|^/etc|^/var|^/usr)')
            if [ -n "$sensitive_mounts" ]; then
                warnings+=("å‘ç°æ•æ„Ÿç›®å½•æŒ‚è½½ï¼Œè¯·ç¡®è®¤å®‰å…¨æ€§")
            fi
            ;;
        "env")
            # æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
            if grep -iE '(password|secret|key|token)' "$file" | grep -v '^#'; then
                warnings+=("é…ç½®æ–‡ä»¶ä¸­å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œå»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†")
            fi
            
            # æ£€æŸ¥é»˜è®¤å¯†ç 
            if grep -iE '(password=admin|password=root|password=123)' "$file"; then
                errors+=("å‘ç°é»˜è®¤å¯†ç ï¼Œå­˜åœ¨ä¸¥é‡å®‰å…¨é£é™©")
            fi
            ;;
        "yaml"|"json")
            # æ£€æŸ¥é…ç½®ä¸­çš„æ•æ„Ÿä¿¡æ¯
            local content
            if [ "$type" = "yaml" ]; then
                content=$(yq eval -o=json '.' "$file")
            else
                content=$(cat "$file")
            fi
            
            if echo "$content" | jq -r '.. | select(type == "string")' | grep -iE '(password|secret|key|token)'; then
                warnings+=("é…ç½®ä¸­å¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯")
            fi
            ;;
    esac
    
    # æ£€æŸ¥æ–‡ä»¶æƒé™
    local file_perms
    file_perms=$(stat -c "%a" "$file" 2>/dev/null || stat -f "%Lp" "$file" 2>/dev/null)
    if [ "${file_perms: -1}" != "0" ] && [ "${file_perms: -1}" != "4" ]; then
        warnings+=("æ–‡ä»¶æƒé™è¿‡äºå®½æ¾ ($file_perms)ï¼Œå»ºè®®è®¾ç½®ä¸º 644")
    fi
    
    # è¾“å‡ºç»“æœ
    printf 'ERRORS:\n'
    printf '%s\n' "${errors[@]}"
    printf 'WARNINGS:\n'
    printf '%s\n' "${warnings[@]}"
}

# éªŒè¯æ€§èƒ½é…ç½®
validate_performance() {
    local file="$1"
    local type="$2"
    local warnings=()
    local suggestions=()
    
    case "$type" in
        "docker-compose")
            # æ£€æŸ¥èµ„æºé™åˆ¶
            if ! yq eval '.services[] | select(has("deploy")) | .deploy.resources' "$file" 2>/dev/null | grep -q "limits"; then
                suggestions+=("å»ºè®®ä¸ºæœåŠ¡é…ç½®èµ„æºé™åˆ¶ä»¥é˜²æ­¢èµ„æºè€—å°½")
            fi
            
            # æ£€æŸ¥å¥åº·æ£€æŸ¥
            if ! yq eval '.services[] | select(has("healthcheck"))' "$file" 2>/dev/null | grep -q "healthcheck"; then
                suggestions+=("å»ºè®®é…ç½®å¥åº·æ£€æŸ¥ä»¥æé«˜æœåŠ¡å¯é æ€§")
            fi
            
            # æ£€æŸ¥é‡å¯ç­–ç•¥
            if ! yq eval '.services[].restart' "$file" 2>/dev/null | grep -q "unless-stopped"; then
                suggestions+=("å»ºè®®é…ç½®åˆé€‚çš„é‡å¯ç­–ç•¥")
            fi
            ;;
        "env")
            # æ£€æŸ¥ Jaeger é‡‡æ ·ç‡
            local sampling_rate
            sampling_rate=$(grep "SAMPLING_RATE\|JAEGER.*SAMPLE" "$file" | grep -oE '[0-9.]+' | head -n1)
            if [ -n "$sampling_rate" ]; then
                if [ "$(echo "$sampling_rate > 0.1" | bc 2>/dev/null || echo 0)" -eq 1 ]; then
                    warnings+=("Jaeger é‡‡æ ·ç‡è¾ƒé«˜ ($sampling_rate)ï¼Œå¯èƒ½å½±å“æ€§èƒ½")
                fi
            fi
            
            # æ£€æŸ¥ç¼“å­˜é…ç½®
            if ! grep -q "CACHE\|REDIS\|MEMCACHE" "$file"; then
                suggestions+=("è€ƒè™‘é…ç½®ç¼“å­˜ä»¥æå‡æ€§èƒ½")
            fi
            ;;
        "yaml"|"json")
            local content
            if [ "$type" = "yaml" ]; then
                content=$(yq eval -o=json '.' "$file")
            else
                content=$(cat "$file")
            fi
            
            # æ£€æŸ¥è¿æ¥æ± é…ç½®
            if echo "$content" | jq -e '.database' >/dev/null 2>&1; then
                if ! echo "$content" | jq -e '.database.pool' >/dev/null 2>&1; then
                    suggestions+=("å»ºè®®é…ç½®æ•°æ®åº“è¿æ¥æ± ")
                fi
            fi
            
            # æ£€æŸ¥è¶…æ—¶é…ç½®
            if ! echo "$content" | jq -e '.. | select(type == "object") | has("timeout")' >/dev/null 2>&1; then
                suggestions+=("å»ºè®®é…ç½®é€‚å½“çš„è¶…æ—¶æ—¶é—´")
            fi
            ;;
    esac
    
    # è¾“å‡ºç»“æœ
    printf 'WARNINGS:\n'
    printf '%s\n' "${warnings[@]}"
    printf 'SUGGESTIONS:\n'
    printf '%s\n' "${suggestions[@]}"
}

# è‡ªåŠ¨ä¿®å¤é—®é¢˜
auto_fix() {
    local file="$1"
    local type="$2"
    local fixes=()
    
    if [ ! -w "$file" ]; then
        log_error "æ–‡ä»¶ä¸å¯å†™ï¼Œæ— æ³•è‡ªåŠ¨ä¿®å¤: $file"
        return 1
    fi
    
    # åˆ›å»ºå¤‡ä»½
    local backup_file="${file}.backup.$(date +%s)"
    cp "$file" "$backup_file"
    fixes+=("å·²åˆ›å»ºå¤‡ä»½æ–‡ä»¶: $backup_file")
    
    case "$type" in
        "env")
            # ä¿®å¤æ–‡ä»¶æƒé™
            if [ "$(stat -c "%a" "$file" 2>/dev/null || stat -f "%Lp" "$file" 2>/dev/null)" != "644" ]; then
                chmod 644 "$file"
                fixes+=("å·²ä¿®å¤æ–‡ä»¶æƒé™ä¸º 644")
            fi
            
            # æ·»åŠ ç¼ºå¤±çš„ç¯å¢ƒå˜é‡
            local missing_vars=(
                "JAEGER_UI_PORT=16686"
                "ORDER_SERVICE_PORT=8081"
                "PAYMENT_SERVICE_PORT=8082"
                "INVENTORY_SERVICE_PORT=8083"
            )
            
            for var in "${missing_vars[@]}"; do
                local var_name="${var%=*}"
                if ! grep -q "^$var_name=" "$file"; then
                    echo "# Added by config-validator" >> "$file"
                    echo "$var" >> "$file"
                    fixes+=("å·²æ·»åŠ ç¼ºå¤±çš„ç¯å¢ƒå˜é‡: $var_name")
                fi
            done
            ;;
        "docker-compose"|"yaml")
            # å¯¹äº YAML æ–‡ä»¶çš„ä¿®å¤æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡ŒåªåšåŸºç¡€ä¿®å¤
            if command -v yamllint &> /dev/null; then
                # å°è¯•æ ¼å¼åŒ– YAML
                if yq eval '.' "$file" > "${file}.tmp" 2>/dev/null; then
                    mv "${file}.tmp" "$file"
                    fixes+=("å·²æ ¼å¼åŒ– YAML æ–‡ä»¶")
                else
                    rm -f "${file}.tmp"
                fi
            fi
            ;;
        "json")
            # æ ¼å¼åŒ– JSON
            if jq '.' "$file" > "${file}.tmp" 2>/dev/null; then
                mv "${file}.tmp" "$file"
                fixes+=("å·²æ ¼å¼åŒ– JSON æ–‡ä»¶")
            else
                rm -f "${file}.tmp"
            fi
            ;;
    esac
    
    printf '%s\n' "${fixes[@]}"
}

# éªŒè¯å•ä¸ªæ–‡ä»¶
validate_file() {
    local file="$1"
    local type="$2"
    local checks="$3"
    
    if [ ! -f "$file" ]; then
        log_error "æ–‡ä»¶ä¸å­˜åœ¨: $file"
        return 1
    fi
    
    # è‡ªåŠ¨æ£€æµ‹ç±»å‹
    if [ "$type" = "auto" ]; then
        type=$(detect_config_type "$file")
    fi
    
    log_header "éªŒè¯æ–‡ä»¶: $file (ç±»å‹: $type)"
    
    local total_errors=0
    local total_warnings=0
    local total_suggestions=0
    
    # æ‰§è¡ŒæŒ‡å®šçš„æ£€æŸ¥
    IFS=',' read -ra CHECK_ARRAY <<< "$checks"
    for check in "${CHECK_ARRAY[@]}"; do
        check=$(echo "$check" | xargs) # å»é™¤ç©ºæ ¼
        
        case "$check" in
            "syntax"|"all")
                if [ "$VERBOSE" = "true" ]; then
                    log_info "æ‰§è¡Œè¯­æ³•æ£€æŸ¥..."
                fi
                local syntax_errors
                syntax_errors=$(validate_syntax "$file" "$type")
                if [ -n "$syntax_errors" ]; then
                    echo "$syntax_errors"
                    total_errors=$((total_errors + $(echo "$syntax_errors" | wc -l)))
                fi
                ;;
            "completeness"|"all")
                if [ "$VERBOSE" = "true" ]; then
                    log_info "æ‰§è¡Œå®Œæ•´æ€§æ£€æŸ¥..."
                fi
                local completeness_result
                completeness_result=$(validate_completeness "$file" "$type")
                local comp_errors=$(echo "$completeness_result" | sed -n '/^ERRORS:/,/^WARNINGS:/{//!p;}')
                local comp_warnings=$(echo "$completeness_result" | sed -n '/^WARNINGS:/,${//!p;}')
                
                if [ -n "$comp_errors" ] && [ "$comp_errors" != "" ]; then
                    echo "å®Œæ•´æ€§é”™è¯¯:"
                    echo "$comp_errors"
                    total_errors=$((total_errors + $(echo "$comp_errors" | wc -l)))
                fi
                
                if [ -n "$comp_warnings" ] && [ "$comp_warnings" != "" ]; then
                    echo "å®Œæ•´æ€§è­¦å‘Š:"
                    echo "$comp_warnings"
                    total_warnings=$((total_warnings + $(echo "$comp_warnings" | wc -l)))
                fi
                ;;
            "connectivity"|"all")
                if [ "$VERBOSE" = "true" ]; then
                    log_info "æ‰§è¡Œè¿æ¥æ€§æ£€æŸ¥..."
                fi
                local connectivity_result
                connectivity_result=$(validate_connectivity "$file" "$type")
                local conn_errors=$(echo "$connectivity_result" | sed -n '/^ERRORS:/,/^WARNINGS:/{//!p;}')
                local conn_warnings=$(echo "$connectivity_result" | sed -n '/^WARNINGS:/,${//!p;}')
                
                if [ -n "$conn_errors" ] && [ "$conn_errors" != "" ]; then
                    echo "è¿æ¥æ€§é”™è¯¯:"
                    echo "$conn_errors"
                    total_errors=$((total_errors + $(echo "$conn_errors" | wc -l)))
                fi
                
                if [ -n "$conn_warnings" ] && [ "$conn_warnings" != "" ]; then
                    echo "è¿æ¥æ€§è­¦å‘Š:"
                    echo "$conn_warnings"
                    total_warnings=$((total_warnings + $(echo "$conn_warnings" | wc -l)))
                fi
                ;;
            "security"|"all")
                if [ "$VERBOSE" = "true" ]; then
                    log_info "æ‰§è¡Œå®‰å…¨æ£€æŸ¥..."
                fi
                local security_result
                security_result=$(validate_security "$file" "$type")
                local sec_errors=$(echo "$security_result" | sed -n '/^ERRORS:/,/^WARNINGS:/{//!p;}')
                local sec_warnings=$(echo "$security_result" | sed -n '/^WARNINGS:/,${//!p;}')
                
                if [ -n "$sec_errors" ] && [ "$sec_errors" != "" ]; then
                    echo "å®‰å…¨é”™è¯¯:"
                    echo "$sec_errors"
                    total_errors=$((total_errors + $(echo "$sec_errors" | wc -l)))
                fi
                
                if [ -n "$sec_warnings" ] && [ "$sec_warnings" != "" ]; then
                    echo "å®‰å…¨è­¦å‘Š:"
                    echo "$sec_warnings"
                    total_warnings=$((total_warnings + $(echo "$sec_warnings" | wc -l)))
                fi
                ;;
            "performance"|"all")
                if [ "$VERBOSE" = "true" ]; then
                    log_info "æ‰§è¡Œæ€§èƒ½æ£€æŸ¥..."
                fi
                local perf_result
                perf_result=$(validate_performance "$file" "$type")
                local perf_warnings=$(echo "$perf_result" | sed -n '/^WARNINGS:/,/^SUGGESTIONS:/{//!p;}')
                local perf_suggestions=$(echo "$perf_result" | sed -n '/^SUGGESTIONS:/,${//!p;}')
                
                if [ -n "$perf_warnings" ] && [ "$perf_warnings" != "" ]; then
                    echo "æ€§èƒ½è­¦å‘Š:"
                    echo "$perf_warnings"
                    total_warnings=$((total_warnings + $(echo "$perf_warnings" | wc -l)))
                fi
                
                if [ -n "$perf_suggestions" ] && [ "$perf_suggestions" != "" ]; then
                    echo "æ€§èƒ½å»ºè®®:"
                    echo "$perf_suggestions"
                    total_suggestions=$((total_suggestions + $(echo "$perf_suggestions" | wc -l)))
                fi
                ;;
        esac
    done
    
    # è‡ªåŠ¨ä¿®å¤
    if [ "$AUTO_FIX" = "true" ] && [ $total_errors -gt 0 ]; then
        log_info "å°è¯•è‡ªåŠ¨ä¿®å¤é—®é¢˜..."
        local fixes
        fixes=$(auto_fix "$file" "$type")
        if [ -n "$fixes" ]; then
            echo "è‡ªåŠ¨ä¿®å¤:"
            echo "$fixes"
        fi
    fi
    
    # è¾“å‡ºæ€»ç»“
    echo
    if [ $total_errors -eq 0 ] && [ $total_warnings -eq 0 ]; then
        log_success "âœ… é…ç½®éªŒè¯é€šè¿‡: $file"
    else
        if [ $total_errors -gt 0 ]; then
            log_error "âŒ å‘ç° $total_errors ä¸ªé”™è¯¯"
        fi
        if [ $total_warnings -gt 0 ]; then
            log_warning "âš ï¸  å‘ç° $total_warnings ä¸ªè­¦å‘Š"
        fi
        if [ $total_suggestions -gt 0 ]; then
            log_info "ğŸ’¡ $total_suggestions ä¸ªä¼˜åŒ–å»ºè®®"
        fi
    fi
    
    # ä¸¥æ ¼æ¨¡å¼ä¸‹è­¦å‘Šä¹Ÿè§†ä¸ºé”™è¯¯
    if [ "$STRICT_MODE" = "true" ] && [ $total_warnings -gt 0 ]; then
        total_errors=$((total_errors + total_warnings))
    fi
    
    return $total_errors
}

# ç”Ÿæˆè¾“å‡ºæŠ¥å‘Š
generate_report() {
    local format="$1"
    local results="$2"
    
    case "$format" in
        "json")
            echo "$results" | jq '.'
            ;;
        "html")
            # ç®€å•çš„ HTML æŠ¥å‘Š
            cat << EOF
<!DOCTYPE html>
<html>
<head>
    <title>é…ç½®éªŒè¯æŠ¥å‘Š</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .error { color: red; }
        .warning { color: orange; }
        .success { color: green; }
        .suggestion { color: blue; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ é…ç½®éªŒè¯æŠ¥å‘Š</h1>
    <p>ç”Ÿæˆæ—¶é—´: $(date)</p>
    <pre>$results</pre>
</body>
</html>
EOF
            ;;
        "text"|*)
            echo "$results"
            ;;
    esac
}

# ä¸»å‡½æ•°
main() {
    # é»˜è®¤å‚æ•°
    CONFIG_FILES=()
    CONFIG_TYPE="auto"
    CHECKS="all"
    OUTPUT_FORMAT="text"
    OUTPUT_FILE=""
    AUTO_FIX="false"
    STRICT_MODE="false"
    VERBOSE="false"
    QUIET="false"
    
    # è§£æå‘½ä»¤è¡Œå‚æ•°
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                show_usage
                exit 0
                ;;
            -f|--file)
                CONFIG_FILES+=("$2")
                shift 2
                ;;
            --file=*)
                CONFIG_FILES+=("${1#*=}")
                shift
                ;;
            -t|--type)
                CONFIG_TYPE="$2"
                shift 2
                ;;
            --type=*)
                CONFIG_TYPE="${1#*=}"
                shift
                ;;
            -c|--check)
                CHECKS="$2"
                shift 2
                ;;
            --check=*)
                CHECKS="${1#*=}"
                shift
                ;;
            -o|--output)
                OUTPUT_FORMAT="$2"
                shift 2
                ;;
            --output=*)
                OUTPUT_FORMAT="${1#*=}"
                shift
                ;;
            --output-file=*)
                OUTPUT_FILE="${1#*=}"
                shift
                ;;
            --fix)
                AUTO_FIX="true"
                shift
                ;;
            --strict)
                STRICT_MODE="true"
                shift
                ;;
            --verbose)
                VERBOSE="true"
                shift
                ;;
            --quiet)
                QUIET="true"
                shift
                ;;
            *)
                # ä½œä¸ºé…ç½®æ–‡ä»¶å¤„ç†
                CONFIG_FILES+=("$1")
                shift
                ;;
        esac
    done
    
    if [ "$QUIET" != "true" ]; then
        show_welcome
    fi
    
    check_dependencies
    
    # å¦‚æœæ²¡æœ‰æŒ‡å®šæ–‡ä»¶ï¼Œè‡ªåŠ¨å‘ç°
    if [ ${#CONFIG_FILES[@]} -eq 0 ]; then
        while IFS= read -r file_info; do
            CONFIG_FILES+=("${file_info%:*}")
        done < <(discover_config_files)
    fi
    
    if [ ${#CONFIG_FILES[@]} -eq 0 ]; then
        log_error "æ²¡æœ‰æ‰¾åˆ°é…ç½®æ–‡ä»¶"
        exit 1
    fi
    
    # éªŒè¯é…ç½®æ–‡ä»¶
    local total_exit_code=0
    local all_results=""
    
    for config_file in "${CONFIG_FILES[@]}"; do
        local result_output
        result_output=$(validate_file "$config_file" "$CONFIG_TYPE" "$CHECKS" 2>&1)
        local exit_code=$?
        
        all_results="$all_results\n=== $config_file ===\n$result_output\n"
        
        if [ $exit_code -gt 0 ]; then
            total_exit_code=$exit_code
        fi
    done
    
    # è¾“å‡ºç»“æœ
    local final_output
    final_output=$(generate_report "$OUTPUT_FORMAT" "$all_results")
    
    if [ -n "$OUTPUT_FILE" ]; then
        echo "$final_output" > "$OUTPUT_FILE"
        log_info "ç»“æœå·²ä¿å­˜åˆ°: $OUTPUT_FILE"
    else
        echo "$final_output"
    fi
    
    if [ "$QUIET" != "true" ]; then
        echo
        if [ $total_exit_code -eq 0 ]; then
            log_success "ğŸ‰ æ‰€æœ‰é…ç½®éªŒè¯é€šè¿‡ï¼"
        else
            log_error "âŒ é…ç½®éªŒè¯å¤±è´¥ï¼Œè¯·ä¿®å¤ä¸Šè¿°é—®é¢˜"
        fi
    fi
    
    exit $total_exit_code
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"