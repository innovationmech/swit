apiVersion: v1
kind: Secret
metadata:
  name: {{ include "swit.fullname" . }}-secret
  namespace: {{ include "swit.namespace" . }}
  labels:
    {{- include "swit.labels" . | nindent 4 }}
  annotations:
    # 安全注解
    {{- if and .Values.security.enabled .Values.secret.encryption.enabled }}
    swit.io/encrypted: "true"
    swit.io/encryption-key-rotation: {{ .Values.secret.encryption.rotationDays | quote }}
    {{- end }}
type: Opaque
data:
  # 数据库密码（Base64 编码）
  mysql-root-password: {{ .Values.secret.database.rootPassword | b64enc | quote }}
  mysql-password: {{ .Values.secret.database.password | b64enc | quote }}
  
  # JWT 密钥（已经是 Base64 编码），供文件挂载
  jwt-secret: {{ .Values.secret.jwt.secret | quote }}
  
  {{- if and .Values.secret.encryption.enabled .Values.secret.encryption.key }}
  # 数据加密密钥
  encryption-key: {{ .Values.secret.encryption.key | quote }}
  {{- end }}
  
  {{- if and .Values.security.enabled .Values.security.oauth2.enabled .Values.security.oauth2.clientSecretRef }}
  # OAuth2 客户端密钥（如果提供）
  oauth2-client-secret: {{ .Values.security.oauth2.clientSecretRef | b64enc | quote }}
  {{- end }}
  
  {{- if and .Values.security.enabled .Values.security.apiKey.enabled .Values.security.apiKey.secretRef }}
  # API 密钥（如果提供）
  api-key: {{ .Values.security.apiKey.secretRef | b64enc | quote }}
  {{- end }}
---
{{- if and .Values.security.enabled .Values.security.tls.enabled (not .Values.security.tls.existingSecret) }}
{{- if eq .Values.security.tls.source "self-signed" }}
# 自签名 TLS 证书（仅用于开发/测试）
# 注意：生产环境请使用 cert-manager 或外部证书
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "swit.fullname" . }}-tls
  namespace: {{ include "swit.namespace" . }}
  labels:
    {{- include "swit.labels" . | nindent 4 }}
  annotations:
    swit.io/tls-source: "self-signed"
    swit.io/tls-validity-days: {{ .Values.secret.tls.validityDays | quote }}
type: kubernetes.io/tls
data:
  # 注意：这里需要提供实际的证书内容
  # 生产环境建议使用 cert-manager 自动管理证书
  tls.crt: ""
  tls.key: ""
{{- end }}
{{- if eq .Values.security.tls.source "cert-manager" }}
# cert-manager Certificate 资源
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: {{ include "swit.fullname" . }}-tls
  namespace: {{ include "swit.namespace" . }}
  labels:
    {{- include "swit.labels" . | nindent 4 }}
spec:
  secretName: {{ include "swit.fullname" . }}-tls
  duration: {{ .Values.security.tls.duration }}
  renewBefore: {{ .Values.security.tls.renewBefore }}
  subject:
    organizations:
      - {{ .Values.secret.tls.subject.organization | default "Swit" }}
  commonName: {{ include "swit.fullname" . }}.{{ include "swit.namespace" . }}.svc.cluster.local
  isCA: false
  privateKey:
    algorithm: RSA
    size: 2048
  usages:
    - server auth
    - client auth
  dnsNames:
    - {{ include "swit.fullname" . }}
    - {{ include "swit.fullname" . }}.{{ include "swit.namespace" . }}
    - {{ include "swit.fullname" . }}.{{ include "swit.namespace" . }}.svc
    - {{ include "swit.fullname" . }}.{{ include "swit.namespace" . }}.svc.cluster.local
    {{- range .Values.secret.tls.san.dnsNames }}
    - {{ . }}
    {{- end }}
  {{- if .Values.secret.tls.san.ipAddresses }}
  ipAddresses:
    {{- range .Values.secret.tls.san.ipAddresses }}
    - {{ . }}
    {{- end }}
  {{- end }}
  issuerRef:
    name: {{ .Values.security.tls.issuer.name }}
    kind: {{ .Values.security.tls.issuer.kind }}
{{- end }}
{{- end }}
---
{{- if and .Values.security.enabled .Values.security.mtls.enabled (not .Values.security.mtls.caSecret) }}
# mTLS CA 证书 Secret
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "swit.fullname" . }}-mtls-ca
  namespace: {{ include "swit.namespace" . }}
  labels:
    {{- include "swit.labels" . | nindent 4 }}
  annotations:
    swit.io/mtls-enabled: "true"
    swit.io/mtls-client-auth-mode: {{ .Values.security.mtls.clientAuthMode | quote }}
type: Opaque
data:
  # CA 证书（需要提供实际的 CA 证书内容）
  ca.crt: ""
{{- end }}
---
{{- if and .Values.security.enabled .Values.security.mtls.enabled .Values.security.mtls.clientCertSecret }}
# mTLS 客户端证书 Secret（用于服务间通信）
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "swit.fullname" . }}-mtls-client
  namespace: {{ include "swit.namespace" . }}
  labels:
    {{- include "swit.labels" . | nindent 4 }}
  annotations:
    swit.io/mtls-client-cert: "true"
type: kubernetes.io/tls
data:
  # 客户端证书和密钥（需要提供实际内容）
  tls.crt: ""
  tls.key: ""
{{- end }}