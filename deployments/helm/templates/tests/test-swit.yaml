apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "swit.fullname" . }}-test"
  namespace: {{ include "swit.namespace" . }}
  labels:
    {{- include "swit.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    - name: swit-test
      image: busybox:1.35
      command:
        - sh
        - -c
        - |
          set -e
          
          echo "========================================="
          echo "ğŸ§ª Swit å¾®æœåŠ¡å¹³å°æµ‹è¯•å¼€å§‹"
          echo "========================================="
          
          # æµ‹è¯•å‡½æ•°
          test_service() {
            local service_name=$1
            local port=$2
            local path=${3:-"/health"}
            local expected_code=${4:-200}
            
            echo "ğŸ” æµ‹è¯•æœåŠ¡: $service_name:$port$path"
            
            # æ£€æŸ¥æœåŠ¡æ˜¯å¦å¯è¾¾
            if nc -z "$service_name" "$port"; then
              echo "âœ… æœåŠ¡ $service_name:$port å¯è¾¾"
              
              # å¦‚æœæ˜¯HTTPæœåŠ¡ï¼Œæµ‹è¯•HTTPå“åº”
              if [ "$path" != "" ]; then
                response=$(wget -q -O - --timeout=10 "http://$service_name:$port$path" 2>/dev/null || echo "ERROR")
                if [ "$response" != "ERROR" ]; then
                  echo "âœ… HTTP å“åº”æ­£å¸¸: $service_name$path"
                else
                  echo "âŒ HTTP å“åº”å¤±è´¥: $service_name$path"
                  return 1
                fi
              fi
            else
              echo "âŒ æœåŠ¡ $service_name:$port ä¸å¯è¾¾"
              return 1
            fi
          }
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 10
          
          # æµ‹è¯•è®¡æ•°å™¨
          total_tests=0
          passed_tests=0
          
          {{- if .Values.mysql.enabled }}
          # æµ‹è¯• MySQL è¿æ¥
          total_tests=$((total_tests + 1))
          echo "ğŸ—„ï¸  æµ‹è¯• MySQL æ•°æ®åº“è¿æ¥..."
          if nc -z {{ include "swit.mysql.fullname" . }}-service {{ .Values.mysql.service.port }}; then
            echo "âœ… MySQL æ•°æ®åº“è¿æ¥æ­£å¸¸"
            passed_tests=$((passed_tests + 1))
          else
            echo "âŒ MySQL æ•°æ®åº“è¿æ¥å¤±è´¥"
          fi
          {{- end }}
          
          {{- if .Values.consul.enabled }}
          # æµ‹è¯• Consul æœåŠ¡
          total_tests=$((total_tests + 1))
          if test_service "{{ include "swit.consul.fullname" . }}-service" "{{ .Values.consul.service.httpPort }}" "/v1/status/leader"; then
            passed_tests=$((passed_tests + 1))
          fi
          {{- end }}
          
          {{- if .Values.switAuth.enabled }}
          # æµ‹è¯•è®¤è¯æœåŠ¡
          total_tests=$((total_tests + 1))
          if test_service "{{ include "swit.auth.fullname" . }}-service" "{{ .Values.switAuth.service.port }}" "/health"; then
            passed_tests=$((passed_tests + 1))
          fi
          {{- end }}
          
          {{- if .Values.switServe.enabled }}
          # æµ‹è¯•ä¸»è¦æœåŠ¡
          total_tests=$((total_tests + 1))
          if test_service "{{ include "swit.serve.fullname" . }}-service" "{{ .Values.switServe.service.port }}" "/health"; then
            passed_tests=$((passed_tests + 1))
          fi
          {{- end }}
          
          # æµ‹è¯•æœåŠ¡å‘ç°æ³¨å†Œ
          {{- if and .Values.consul.enabled .Values.switAuth.enabled }}
          total_tests=$((total_tests + 1))
          echo "ğŸ” æµ‹è¯•æœåŠ¡å‘ç°æ³¨å†Œ..."
          services=$(wget -q -O - "http://{{ include "swit.consul.fullname" . }}-service:{{ .Values.consul.service.httpPort }}/v1/catalog/services" 2>/dev/null || echo "{}")
          if echo "$services" | grep -q "swit-auth"; then
            echo "âœ… è®¤è¯æœåŠ¡å·²åœ¨ Consul ä¸­æ³¨å†Œ"
            passed_tests=$((passed_tests + 1))
          else
            echo "âŒ è®¤è¯æœåŠ¡æœªåœ¨ Consul ä¸­æ³¨å†Œ"
          fi
          {{- end }}
          
          # æµ‹è¯•é…ç½®æ–‡ä»¶
          total_tests=$((total_tests + 1))
          echo "ğŸ” æµ‹è¯•é…ç½®æ–‡ä»¶..."
          if [ -f "/tmp/test-config" ]; then
            echo "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨"
            passed_tests=$((passed_tests + 1))
          else
            echo "âš ï¸  é…ç½®æ–‡ä»¶æµ‹è¯•è·³è¿‡ï¼ˆéå…³é”®ï¼‰"
            passed_tests=$((passed_tests + 1))
          fi
          
          # è¾“å‡ºæµ‹è¯•ç»“æœ
          echo "========================================="
          echo "ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»"
          echo "========================================="
          echo "æ€»æµ‹è¯•æ•°: $total_tests"
          echo "é€šè¿‡æµ‹è¯•: $passed_tests"
          echo "å¤±è´¥æµ‹è¯•: $((total_tests - passed_tests))"
          
          if [ "$passed_tests" -eq "$total_tests" ]; then
            echo "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Swit å¹³å°éƒ¨ç½²æˆåŠŸï¼"
            echo ""
            echo "ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
            echo "1. æŸ¥çœ‹æœåŠ¡çŠ¶æ€: kubectl get pods -n {{ include "swit.namespace" . }}"
            echo "2. è®¿é—®æœåŠ¡:"
            {{- if .Values.switServe.external.enabled }}
            echo "   - ä¸»è¦æœåŠ¡: http://<NODE-IP>:{{ .Values.switServe.external.service.nodePort }}"
            {{- end }}
            {{- if .Values.switAuth.external.enabled }}
            echo "   - è®¤è¯æœåŠ¡: http://<NODE-IP>:{{ .Values.switAuth.external.service.nodePort }}"
            {{- end }}
            {{- if .Values.consul.ui.enabled }}
            echo "   - Consul UI: http://<NODE-IP>:{{ .Values.consul.ui.service.nodePort }}"
            {{- end }}
            echo "3. æŸ¥çœ‹æ—¥å¿—: kubectl logs -n {{ include "swit.namespace" . }} -l app.kubernetes.io/name=swit"
            exit 0
          else
            echo "âŒ æµ‹è¯•å¤±è´¥ï¼è¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€å’Œæ—¥å¿—"
            echo ""
            echo "ğŸ”§ æ•…éšœæ’é™¤å»ºè®®ï¼š"
            echo "1. æ£€æŸ¥ Pod çŠ¶æ€: kubectl get pods -n {{ include "swit.namespace" . }}"
            echo "2. æŸ¥çœ‹å¤±è´¥çš„ Pod æ—¥å¿—: kubectl logs -n {{ include "swit.namespace" . }} <pod-name>"
            echo "3. æ£€æŸ¥æœåŠ¡çŠ¶æ€: kubectl get svc -n {{ include "swit.namespace" . }}"
            echo "4. æŸ¥çœ‹äº‹ä»¶: kubectl get events -n {{ include "swit.namespace" . }} --sort-by='.lastTimestamp'"
            exit 1
          fi
      volumeMounts:
        - name: test-config
          mountPath: /tmp/test-config
          subPath: app.yaml
          readOnly: true
  volumes:
    - name: test-config
      configMap:
        name: {{ include "swit.fullname" . }}-config
        items:
          - key: app.yaml
            path: app.yaml
        optional: true 