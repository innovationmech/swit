name: License Check

on:
  push:
    branches: [ master, dev ]
  pull_request:
    branches: [ master, dev ]
  schedule:
    # æ¯æœˆç¬¬ä¸€å¤©æ£€æŸ¥ä¸€æ¬¡
    - cron: '0 0 1 * *'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  license-check:
    name: Check Dependencies License
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23'

    - name: Install go-licenses
      run: go install github.com/google/go-licenses@latest

    - name: Check licenses
      id: license_check
      run: |
        # æ£€æŸ¥ä¾èµ–çš„è®¸å¯è¯
        echo "ğŸ” Checking dependency licenses..."
        
        # åŠ è½½è®¸å¯è¯é…ç½®
        source .licenses
        
        # å…ˆå°è¯•è¿è¡Œè®¸å¯è¯æ£€æŸ¥
        if go-licenses check ./... > license_check.txt 2>&1; then
          echo "check_passed=true" >> $GITHUB_OUTPUT
          echo "âœ… go-licenses check passed"
        else
          echo "check_passed=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ go-licenses check had issues, but continuing with detailed analysis..."
        fi
        
        # ç”Ÿæˆè®¸å¯è¯æŠ¥å‘Š
        echo "ğŸ“„ Generating license report..."
        go-licenses report ./... > licenses.txt 2>&1 || true
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ç¦ç”¨çš„è®¸å¯è¯
        FORBIDDEN_FOUND=false
        REVIEW_NEEDED=false
        
        echo "ğŸ” Checking for forbidden licenses..."
        for license in "${FORBIDDEN_LICENSES[@]}"; do
          if grep -q "$license" licenses.txt; then
            echo "âŒ Found forbidden license: $license"
            FORBIDDEN_FOUND=true
          fi
        done
        
        echo "ğŸ“‹ Checking for licenses requiring review..."
        for license in "${REVIEW_REQUIRED_LICENSES[@]}"; do
          if grep -q "$license" licenses.txt; then
            echo "âš ï¸ Found license requiring review: $license"
            REVIEW_NEEDED=true
          fi
        done
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "forbidden_found=$FORBIDDEN_FOUND" >> $GITHUB_OUTPUT
        echo "review_needed=$REVIEW_NEEDED" >> $GITHUB_OUTPUT
        
        if [ "$FORBIDDEN_FOUND" = "true" ]; then
          echo "âŒ Forbidden licenses detected!"
          exit 1
        else
          echo "âœ… No forbidden licenses found"
        fi
        
        # æ˜¾ç¤ºè®¸å¯è¯ç»Ÿè®¡
        echo "ğŸ“Š License summary:"
        if [ -f "licenses.txt" ]; then
          echo "Found licenses:"
          grep -o '[A-Z][A-Z0-9-]*[0-9]\|MIT\|BSD.*\|Apache.*\|MPL.*' licenses.txt | sort | uniq -c | sort -nr || true
          echo ""
          echo "Total dependencies: $(wc -l < licenses.txt)"
        fi

    - name: Upload license report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: license-report
        path: |
          licenses.txt
          license_check.txt
        retention-days: 90

    - name: Comment on PR
      if: github.event_name == 'pull_request' && steps.license_check.outputs.forbidden_found == 'true'
      uses: actions/github-script@v8
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## âš ï¸ License Check Failed
            
            This PR introduces dependencies with incompatible licenses.
            
            Please review the license report in the artifacts and ensure all dependencies use acceptable licenses.
            
            **Forbidden licenses**: GPL-2.0, GPL-3.0, AGPL-1.0, AGPL-3.0
            
            ---
            *Automated license check by GitHub Actions*`
          });

  copyright-check:
    name: Check Copyright Headers
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check copyright headers
      id: copyright_check
      run: |
        # æ£€æŸ¥ Go æ–‡ä»¶çš„ç‰ˆæƒå¤´
        echo "ğŸ” Checking copyright headers in Go files..."
        
        MISSING_COPYRIGHT=()
        
        for file in $(find . -name "*.go" -not -path "./vendor/*" -not -path "./_output/*" -not -path "./api/gen/*"); do
          if ! head -10 "$file" | grep -q "Copyright"; then
            MISSING_COPYRIGHT+=("$file")
          fi
        done
        
        if [ ${#MISSING_COPYRIGHT[@]} -gt 0 ]; then
          echo "âŒ Files missing copyright headers:"
          printf '%s\n' "${MISSING_COPYRIGHT[@]}"
          echo "missing_copyright=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… All Go files have copyright headers"
          echo "missing_copyright=false" >> $GITHUB_OUTPUT
        fi

    - name: Add copyright headers
      if: steps.copyright_check.outputs.missing_copyright == 'true'
      run: |
        # ä½¿ç”¨é¡¹ç›®ä¸­çš„ç‰ˆæƒç®¡ç†å·¥å…·
        if [ -f "scripts/tools/copyright-manage.sh" ]; then
          echo "ğŸ“ Adding missing copyright headers..."
          bash scripts/tools/copyright-manage.sh add
        else
          echo "âš ï¸ Copyright management script not found"
        fi

    - name: Create PR for copyright fixes
      if: steps.copyright_check.outputs.missing_copyright == 'true' && github.event_name == 'push'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: add missing copyright headers"
        title: "ğŸ“„ Add Missing Copyright Headers"
        body: |
          ## ğŸ“„ Copyright Headers Update
          
          This PR adds missing copyright headers to Go source files.
          
          ### Changes
          - Added copyright headers to files that were missing them
          - Ensures compliance with project licensing requirements
          
          ---
          *This PR was automatically created by the license check workflow.*
        branch: copyright-headers-update
        delete-branch: true
