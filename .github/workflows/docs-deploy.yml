name: ğŸ“š Deploy Documentation

on:
  push:
    branches: [master]
    paths:
      - 'docs/pages/**'
      - '.github/workflows/docs-deploy.yml'
  # PR ä»ç„¶ä¼šè¿è¡Œ docs æ„å»ºæ£€æŸ¥ï¼ˆå¦‚æœä½ å¸Œæœ›ä¿ç•™ buildï¼Œå¯å•ç‹¬ä¿ç•™ pull_request è§¦å‘ã€‚
  # è¿™é‡Œç§»é™¤å¯¹ deploy çš„ PR éƒ¨ç½²ï¼ŒçœŸæ­£éƒ¨ç½²ä»…åœ¨åˆå¹¶äº§ç”Ÿçš„ push ä¸Šè¿›è¡Œã€‚ï¼‰
  pull_request:
    branches: [master]
    paths:
      - 'docs/pages/**'
      - '.github/workflows/docs-deploy.yml'
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹åŒæ­¥æ–‡æ¡£å†…å®¹
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      force_sync:
        description: 'Force sync all content'
        required: false
        default: false
        type: boolean

# è®¾ç½®æƒé™
permissions:
  contents: write  # éœ€è¦å†™æƒé™ä»¥ä¾¿æäº¤åŒæ­¥çš„æ–‡æ¡£
  pages: write
  id-token: write

# å…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  NODE_VERSION: '18'
  DOCS_DIR: './docs/pages'

jobs:
  # åˆ†ææ–‡æ¡£å˜æ›´ï¼ˆæ”¯æŒ PR / pushï¼‰
  analyze-changes:
    runs-on: ubuntu-latest
    outputs:
      total-changes: ${{ steps.analyze.outputs.total }}
      markdown-changes: ${{ steps.analyze.outputs.markdown }}
      vue-changes: ${{ steps.analyze.outputs.vue }}
      config-changes: ${{ steps.analyze.outputs.config }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Analyze documentation changes
        id: analyze
        run: |
          echo "ğŸ” Analyzing documentation changes..."
          echo "Event: $GITHUB_EVENT_NAME  Ref: $GITHUB_REF  Base: $GITHUB_BASE_REF"

          # è®¡ç®—å¯¹æ¯”èŒƒå›´ï¼š
          # PR: ä½¿ç”¨ merge base (github.event.pull_request.base.sha) ä¸ HEAD
          # push åˆ° master: å¯¹æ¯” HEAD^...HEAD ä»¥æ•è·åˆšåˆå¹¶çš„ commit å˜æ›´
          # å®šæ—¶/æ‰‹åŠ¨: ä»ä½¿ç”¨ origin/master...HEADï¼ˆå¯èƒ½åŒ…å«å¤šä¸ª commit èšåˆå˜æ›´ï¼‰
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            RANGE="$BASE_SHA...HEAD"
          elif [ "$GITHUB_EVENT_NAME" = "push" ] && [ "$GITHUB_REF" = "refs/heads/master" ]; then
            # é¿å…æ•´ä¸ªå†å² diff
            RANGE="HEAD^...HEAD"
          else
            RANGE="origin/master...HEAD"
          fi

          echo "Using diff range: $RANGE"
          git diff --name-only $RANGE -- docs/pages/ > changed_files.txt
          
          if [ -s changed_files.txt ]; then
            echo "ğŸ“ Changed files:"
            cat changed_files.txt
            
            # ç»Ÿè®¡å˜æ›´ - ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹æ³•
            TOTAL_CHANGES=$(wc -l < changed_files.txt)
            
            # ç»Ÿè®¡ Markdown æ–‡ä»¶
            MD_CHANGES=$(grep '\.md$' changed_files.txt | wc -l || echo 0)
            
            # ç»Ÿè®¡ Vue æ–‡ä»¶
            VUE_CHANGES=$(grep '\.vue$' changed_files.txt | wc -l || echo 0)
            
            # ç»Ÿè®¡é…ç½®æ–‡ä»¶
            CONFIG_CHANGES=$(grep -E '\.(json|yaml|yml)$|config' changed_files.txt | wc -l || echo 0)
            
            # è¾“å‡ºç»“æœ
            echo "total=${TOTAL_CHANGES}" >> $GITHUB_OUTPUT
            echo "markdown=${MD_CHANGES}" >> $GITHUB_OUTPUT
            echo "vue=${VUE_CHANGES}" >> $GITHUB_OUTPUT
            echo "config=${CONFIG_CHANGES}" >> $GITHUB_OUTPUT
            
            echo "ğŸ“Š Change summary:"
            echo "  Total files: $TOTAL_CHANGES"
            echo "  Markdown files: $MD_CHANGES"
            echo "  Vue components: $VUE_CHANGES"
            echo "  Config files: $CONFIG_CHANGES"
          else
            echo "ğŸ“ No documentation files changed"
            echo "total=0" >> $GITHUB_OUTPUT
            echo "markdown=0" >> $GITHUB_OUTPUT
            echo "vue=0" >> $GITHUB_OUTPUT
            echo "config=0" >> $GITHUB_OUTPUT
          fi

  # æ£€æµ‹æ–‡æ¡£å˜æ›´
  detect-changes:
    runs-on: ubuntu-latest
    needs: analyze-changes
    outputs:
      docs-changed: ${{ steps.changes.outputs.docs }}
      content-changed: ${{ steps.changes.outputs.content }}
      force-deploy: ${{ github.event.inputs.force_sync == 'true' || github.event_name == 'schedule' }}
      has-doc-changes: ${{ needs.analyze-changes.outputs.total-changes != '0' }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ” Detect changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            docs:
              - 'docs/pages/**'
              - '.github/workflows/docs-deploy.yml'
            content:
              - 'README.md'
              - 'api/**'
              - 'internal/**/*.go'
              - 'pkg/**/*.go'

  # åŒæ­¥å†…å®¹
  sync-content:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.content-changed == 'true' || needs.detect-changes.outputs.force-deploy == 'true'
    permissions:
      contents: write  # æ˜ç¡®è®¾ç½®å†™æƒé™
    outputs:
      content_updated: ${{ steps.sync.outputs.content_updated || 'false' }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿æ­£ç¡®æäº¤

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.DOCS_DIR }}/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: npm ci

      - name: ğŸ”„ Sync documentation content
        id: sync
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ğŸ”„ Syncing documentation content..."
          
          # è¿è¡Œå†…å®¹åŒæ­¥è„šæœ¬
          if [ -f "scripts/sync-docs.js" ]; then
            node scripts/sync-docs.js
          fi
          
          # ç”Ÿæˆ API æ–‡æ¡£
          if [ -f "scripts/api-docs-generator.js" ]; then
            node scripts/api-docs-generator.js
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if [ -n "$(git status --porcelain)" ]; then
            echo "content_updated=true" >> $GITHUB_OUTPUT
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add -A
            git commit -m "ğŸ“š Auto-sync documentation content

            ğŸ¤– Generated with GitHub Actions
            
            Synced at: $(date -u)"
            git push
          else
            echo "content_updated=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ No content changes detected"
          fi

  # æ„å»ºæ–‡æ¡£
  build:
    runs-on: ubuntu-latest
    needs: [analyze-changes, detect-changes, sync-content]
    # PR åœºæ™¯ï¼šå¦‚æœæœ‰ docs ç›®å½•å˜æ›´ï¼ˆæ¥è‡ª paths-filterï¼‰æˆ– analyze-changes æœ‰ç»Ÿè®¡åˆ™æ„å»º
    # push / schedule / workflow_dispatch: æ²¿ç”¨åŸé€»è¾‘
    if: >
      always() && (
        github.event_name == 'pull_request' && (needs.analyze-changes.outputs.total-changes != '0') ||
        needs.detect-changes.outputs.docs-changed == 'true' ||
        needs.analyze-changes.outputs.total-changes != '0' ||
        (needs.sync-content.result == 'success' && needs.sync-content.outputs.content_updated == 'true') ||
        needs.detect-changes.outputs.force-deploy == 'true'
      )
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.DOCS_DIR }}/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          npm ci
          echo "ğŸ“¦ Dependencies installed successfully"

      - name: ğŸ”§ Configure build environment
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ğŸ”§ Configuring build environment..."
          
          # è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡
          echo "NODE_ENV=production" >> $GITHUB_ENV
          echo "VITE_BUILD_TIME=$(date -u)" >> $GITHUB_ENV
          echo "VITE_COMMIT_SHA=${{ github.sha }}" >> $GITHUB_ENV
          echo "VITE_COMMIT_REF=${{ github.ref_name }}" >> $GITHUB_ENV
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ ! -f ".vitepress/config.mjs" ]; then
            echo "âŒ VitePress config file not found"
            exit 1
          fi

      - name: ğŸ” Lint and type check
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ğŸ” Running linting and type checks..."
          
          # ESLint æ£€æŸ¥
          if [ -f ".eslintrc.js" ]; then
            npm run lint
          fi
          
          # TypeScript ç±»å‹æ£€æŸ¥
          if [ -f "tsconfig.json" ]; then
            npx vue-tsc --noEmit
          fi

      - name: ğŸ§ª Run tests
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ğŸ§ª Running tests..."
          
          # å•å…ƒæµ‹è¯•
          if npm run test:unit --if-present; then
            echo "âœ… Unit tests passed"
          else
            echo "âš ï¸ Unit tests not available or failed"
          fi
          
          # å¯è®¿é—®æ€§æµ‹è¯•ï¼ˆéé˜»å¡ï¼‰
          if npm run test:accessibility --if-present; then
            echo "âœ… Accessibility tests passed"
          else
            echo "âš ï¸ Accessibility tests not available"
          fi

      - name: ğŸ—ï¸ Build documentation
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ğŸ—ï¸ Building documentation..."
          npm run build
          
          # éªŒè¯æ„å»ºè¾“å‡º
          if [ ! -d "dist" ]; then
            echo "âŒ Build output directory not found"
            exit 1
          fi
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Main index.html not found in build output"
            exit 1
          fi
          
          echo "âœ… Documentation built successfully"

      - name: ğŸ“Š Analyze bundle size
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ğŸ“Š Analyzing bundle size..."
          
          # ç”Ÿæˆæ„å»ºåˆ†ææŠ¥å‘Š
          du -sh dist
          find dist -name "*.js" -exec du -h {} \; | sort -hr | head -10
          find dist -name "*.css" -exec du -h {} \; | sort -hr | head -5
          
          # æ£€æŸ¥åŒ…å¤§å°é™åˆ¶
          DIST_SIZE=$(du -s dist | cut -f1)
          MAX_SIZE=50000  # 50MB in KB
          
          if [ $DIST_SIZE -gt $MAX_SIZE ]; then
            echo "âš ï¸ Build size ($DIST_SIZE KB) exceeds limit ($MAX_SIZE KB)"
          else
            echo "âœ… Build size within limits ($DIST_SIZE KB)"
          fi

      - name: ğŸ”§ Prepare deployment files
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ğŸ”§ Preparing deployment files..."
          
          # åˆ›å»º .nojekyll æ–‡ä»¶ï¼ˆGitHub Pagesï¼‰
          touch dist/.nojekyll
          
          # æ·»åŠ è‡ªå®šä¹‰ 404 é¡µé¢
          if [ ! -f "dist/404.html" ]; then
            cp dist/index.html dist/404.html
          fi
          
          # ç”Ÿæˆéƒ¨ç½²ä¿¡æ¯æ–‡ä»¶
          cat > dist/deployment-info.json << EOF
          {
            "buildTime": "$(date -u)",
            "commitSha": "${{ github.sha }}",
            "commitRef": "${{ github.ref_name }}",
            "workflow": "${{ github.workflow }}",
            "runId": "${{ github.run_id }}"
          }
          EOF

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.DOCS_DIR }}/dist
  # éƒ¨ç½²åˆ° GitHub Pages
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pages: write
      id-token: write
    # ä»…åœ¨åˆå¹¶ PR åçš„ master push æ‰§è¡Œéƒ¨ç½²ï¼ˆåˆå¹¶ä¼šè§¦å‘ push äº‹ä»¶ä¸” ref=refs/heads/masterï¼‰
    if: github.ref == 'refs/heads/master'
    outputs:
      page_url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ‰ Deployment success notification
        run: |
          echo "ğŸ‰ Documentation deployed successfully!"
          echo "ğŸ“„ Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "â° Deployed at: $(date -u)"

  # æ€§èƒ½æµ‹è¯•
  performance-test:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/master'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x

      - name: ğŸ” Run Lighthouse CI
        run: |
          lhci autorun || echo "âš ï¸ Lighthouse CI failed, continuing..."

  # éƒ¨ç½²åéªŒè¯
  post-deploy-verification:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/master'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.DOCS_DIR }}/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: npm ci

      - name: ğŸ”— Get deployment URL
        id: get-deploy-url
        run: |
          PAGE_URL="${{ needs.deploy.outputs.page_url }}"
          echo "page_url=${PAGE_URL:-https://docs.example.com}" >> $GITHUB_OUTPUT

      - name: ğŸ§ª Run E2E tests against deployed site
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ğŸ§ª Running E2E tests against deployed site..."
          
          # è®¾ç½®åŸºç¡€ URL ä¸ºéƒ¨ç½²çš„ç«™ç‚¹
          export BASE_URL="${{ steps.get-deploy-url.outputs.page_url }}"
          
          # ç­‰å¾…ç«™ç‚¹å¯ç”¨
          timeout 300 bash -c 'until curl -s "$BASE_URL" > /dev/null; do sleep 5; done'
          
          # è¿è¡Œ E2E æµ‹è¯•
          if npm run test:e2e:production --if-present; then
            echo "âœ… E2E tests passed"
          else
            echo "âš ï¸ E2E tests not available"
          fi

      - name: ğŸ” Verify site accessibility
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ğŸ” Verifying site accessibility..."
          
          # è¿è¡Œå¯è®¿é—®æ€§æµ‹è¯•
          if npm run test:accessibility:production --if-present; then
            echo "âœ… Accessibility verification passed"
          else
            echo "âš ï¸ Accessibility tests not available"
          fi

  # æ¸…ç†å’Œé€šçŸ¥
  cleanup-and-notify:
    runs-on: ubuntu-latest
    needs: [deploy, performance-test, post-deploy-verification]
    if: always() && github.ref == 'refs/heads/master'
    steps:
      - name: ğŸ“Š Generate deployment report
        run: |
          echo "ğŸ“Š Deployment Report"
          echo "=================="
          echo "ğŸš€ Deployment: ${{ needs.deploy.result }}"
          echo "âš¡ Performance Test: ${{ needs.performance-test.result }}"
          echo "ğŸ” Post-Deploy Verification: ${{ needs.post-deploy-verification.result }}"
          echo "â° Completed at: $(date -u)"

      - name: ğŸ”” Notify on failure
        if: failure()
        run: |
          echo "âŒ Documentation deployment failed!"
          echo "ğŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # è¿™é‡Œå¯ä»¥æ·»åŠ  Slackã€Discord æˆ–é‚®ä»¶é€šçŸ¥

      - name: ğŸ”— Get site URL for notification
        id: get-site-url
        run: |
          PAGE_URL="${{ needs.deploy.outputs.page_url }}"
          echo "page_url=${PAGE_URL:-https://docs.example.com}" >> $GITHUB_OUTPUT

      - name: ğŸ‰ Notify on success
        if: success()
        run: |
          echo "âœ… Documentation deployment completed successfully!"
          echo "ğŸ“„ Site: ${{ steps.get-site-url.outputs.page_url }}"