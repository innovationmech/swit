name: ðŸ“š Deploy Documentation

on:
  push:
    branches: [master]
    paths:
      - 'docs/pages/**'
      - '.github/workflows/docs-deploy.yml'
  schedule:
    # æ¯å¤©å‡Œæ™¨ 2 ç‚¹åŒæ­¥æ–‡æ¡£å†…å®¹
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      force_sync:
        description: 'Force sync all content'
        required: false
        default: false
        type: boolean

# è®¾ç½®æƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# å…è®¸ä¸€ä¸ªå¹¶å‘éƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  NODE_VERSION: '18'
  DOCS_DIR: './docs/pages'

jobs:
  # æ£€æµ‹æ–‡æ¡£å˜æ›´
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      docs-changed: ${{ steps.changes.outputs.docs }}
      content-changed: ${{ steps.changes.outputs.content }}
      force-deploy: ${{ github.event.inputs.force_sync == 'true' || github.event_name == 'schedule' }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ðŸ” Detect changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            docs:
              - 'docs/pages/**'
              - '.github/workflows/docs-deploy.yml'
            content:
              - 'README.md'
              - 'api/**'
              - 'internal/**/*.go'
              - 'pkg/**/*.go'

  # åŒæ­¥å†…å®¹
  sync-content:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.content-changed == 'true' || needs.detect-changes.outputs.force-deploy == 'true'
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.DOCS_DIR }}/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: npm ci

      - name: ðŸ”„ Sync documentation content
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ”„ Syncing documentation content..."
          
          # è¿è¡Œå†…å®¹åŒæ­¥è„šæœ¬
          if [ -f "scripts/sync-docs.js" ]; then
            node scripts/sync-docs.js
          fi
          
          # ç”Ÿæˆ API æ–‡æ¡£
          if [ -f "scripts/api-docs-generator.js" ]; then
            node scripts/api-docs-generator.js
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if [ -n "$(git status --porcelain)" ]; then
            echo "content_updated=true" >> $GITHUB_OUTPUT
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add -A
            git commit -m "ðŸ“š Auto-sync documentation content

            ðŸ¤– Generated with GitHub Actions
            
            Synced at: $(date -u)"
            git push
          else
            echo "content_updated=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ No content changes detected"
          fi

  # æž„å»ºæ–‡æ¡£
  build:
    runs-on: ubuntu-latest
    needs: [detect-changes, sync-content]
    if: always() && (needs.detect-changes.outputs.docs-changed == 'true' || needs.sync-content.outputs.content_updated == 'true' || needs.detect-changes.outputs.force-deploy == 'true')
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.DOCS_DIR }}/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          npm ci
          echo "ðŸ“¦ Dependencies installed successfully"

      - name: ðŸ”§ Configure build environment
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ”§ Configuring build environment..."
          
          # è®¾ç½®æž„å»ºçŽ¯å¢ƒå˜é‡
          echo "NODE_ENV=production" >> $GITHUB_ENV
          echo "VITE_BUILD_TIME=$(date -u)" >> $GITHUB_ENV
          echo "VITE_COMMIT_SHA=${{ github.sha }}" >> $GITHUB_ENV
          echo "VITE_COMMIT_REF=${{ github.ref_name }}" >> $GITHUB_ENV
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ ! -f ".vitepress/config.mjs" ]; then
            echo "âŒ VitePress config file not found"
            exit 1
          fi

      - name: ðŸ” Lint and type check
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ” Running linting and type checks..."
          
          # ESLint æ£€æŸ¥
          if [ -f ".eslintrc.js" ]; then
            npm run lint
          fi
          
          # TypeScript ç±»åž‹æ£€æŸ¥
          if [ -f "tsconfig.json" ]; then
            npx vue-tsc --noEmit
          fi

      - name: ðŸ§ª Run tests
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ§ª Running tests..."
          
          # å•å…ƒæµ‹è¯•
          if npm run test:unit --if-present; then
            echo "âœ… Unit tests passed"
          else
            echo "âš ï¸ Unit tests not available or failed"
          fi
          
          # å¯è®¿é—®æ€§æµ‹è¯•ï¼ˆéžé˜»å¡žï¼‰
          if npm run test:accessibility --if-present; then
            echo "âœ… Accessibility tests passed"
          else
            echo "âš ï¸ Accessibility tests not available"
          fi

      - name: ðŸ—ï¸ Build documentation
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ—ï¸ Building documentation..."
          npm run build
          
          # éªŒè¯æž„å»ºè¾“å‡º
          if [ ! -d ".vitepress/dist" ]; then
            echo "âŒ Build output directory not found"
            exit 1
          fi
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          if [ ! -f ".vitepress/dist/index.html" ]; then
            echo "âŒ Main index.html not found in build output"
            exit 1
          fi
          
          echo "âœ… Documentation built successfully"

      - name: ðŸ“Š Analyze bundle size
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ“Š Analyzing bundle size..."
          
          # ç”Ÿæˆæž„å»ºåˆ†æžæŠ¥å‘Š
          du -sh .vitepress/dist
          find .vitepress/dist -name "*.js" -exec du -h {} \; | sort -hr | head -10
          find .vitepress/dist -name "*.css" -exec du -h {} \; | sort -hr | head -5
          
          # æ£€æŸ¥åŒ…å¤§å°é™åˆ¶
          DIST_SIZE=$(du -s .vitepress/dist | cut -f1)
          MAX_SIZE=50000  # 50MB in KB
          
          if [ $DIST_SIZE -gt $MAX_SIZE ]; then
            echo "âš ï¸ Build size ($DIST_SIZE KB) exceeds limit ($MAX_SIZE KB)"
          else
            echo "âœ… Build size within limits ($DIST_SIZE KB)"
          fi

      - name: ðŸ”§ Prepare deployment files
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ”§ Preparing deployment files..."
          
          # åˆ›å»º .nojekyll æ–‡ä»¶ï¼ˆGitHub Pagesï¼‰
          touch .vitepress/dist/.nojekyll
          
          # æ·»åŠ è‡ªå®šä¹‰ 404 é¡µé¢
          if [ ! -f ".vitepress/dist/404.html" ]; then
            cp .vitepress/dist/index.html .vitepress/dist/404.html
          fi
          
          # ç”Ÿæˆéƒ¨ç½²ä¿¡æ¯æ–‡ä»¶
          cat > .vitepress/dist/deployment-info.json << EOF
          {
            "buildTime": "$(date -u)",
            "commitSha": "${{ github.sha }}",
            "commitRef": "${{ github.ref_name }}",
            "workflow": "${{ github.workflow }}",
            "runId": "${{ github.run_id }}"
          }
          EOF

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: '${{ env.DOCS_DIR }}/.vitepress/dist'

  # éƒ¨ç½²åˆ° GitHub Pages
  deploy:
    environment: production
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pages: write
      id-token: write
    if: github.ref == 'refs/heads/master'
    steps:
      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ðŸŽ‰ Deployment success notification
        run: |
          echo "ðŸŽ‰ Documentation deployed successfully!"
          echo "ðŸ“„ Site URL: ${{ steps.deployment.outputs.page_url }}"
          echo "â° Deployed at: $(date -u)"

  # æ€§èƒ½æµ‹è¯•
  performance-test:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/master'
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x

      - name: ðŸ” Run Lighthouse CI
        run: |
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # éƒ¨ç½²åŽéªŒè¯
  post-deploy-verification:
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/master'
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.DOCS_DIR }}/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: npm ci

      - name: ðŸ”— Get deployment URL
        id: get-deploy-url
        run: |
          PAGE_URL="${{ needs.deploy.outputs.page_url }}"
          echo "page_url=${PAGE_URL:-https://docs.example.com}" >> $GITHUB_OUTPUT

      - name: ðŸ§ª Run E2E tests against deployed site
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ§ª Running E2E tests against deployed site..."
          
          # è®¾ç½®åŸºç¡€ URL ä¸ºéƒ¨ç½²çš„ç«™ç‚¹
          export BASE_URL="${{ steps.get-deploy-url.outputs.page_url }}"
          
          # ç­‰å¾…ç«™ç‚¹å¯ç”¨
          timeout 300 bash -c 'until curl -s "$BASE_URL" > /dev/null; do sleep 5; done'
          
          # è¿è¡Œ E2E æµ‹è¯•
          if npm run test:e2e:production --if-present; then
            echo "âœ… E2E tests passed"
          else
            echo "âš ï¸ E2E tests not available"
          fi

      - name: ðŸ” Verify site accessibility
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ” Verifying site accessibility..."
          
          # è¿è¡Œå¯è®¿é—®æ€§æµ‹è¯•
          if npm run test:accessibility:production --if-present; then
            echo "âœ… Accessibility verification passed"
          else
            echo "âš ï¸ Accessibility tests not available"
          fi

  # æ¸…ç†å’Œé€šçŸ¥
  cleanup-and-notify:
    runs-on: ubuntu-latest
    needs: [deploy, performance-test, post-deploy-verification]
    if: always() && github.ref == 'refs/heads/master'
    steps:
      - name: ðŸ“Š Generate deployment report
        run: |
          echo "ðŸ“Š Deployment Report"
          echo "=================="
          echo "ðŸš€ Deployment: ${{ needs.deploy.result }}"
          echo "âš¡ Performance Test: ${{ needs.performance-test.result }}"
          echo "ðŸ” Post-Deploy Verification: ${{ needs.post-deploy-verification.result }}"
          echo "â° Completed at: $(date -u)"

      - name: ðŸ”” Notify on failure
        if: failure()
        run: |
          echo "âŒ Documentation deployment failed!"
          echo "ðŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # è¿™é‡Œå¯ä»¥æ·»åŠ  Slackã€Discord æˆ–é‚®ä»¶é€šçŸ¥

      - name: ðŸ”— Get site URL for notification
        id: get-site-url
        run: |
          PAGE_URL="${{ needs.deploy.outputs.page_url }}"
          echo "page_url=${PAGE_URL:-https://docs.example.com}" >> $GITHUB_OUTPUT

      - name: ðŸŽ‰ Notify on success
        if: success()
        run: |
          echo "âœ… Documentation deployment completed successfully!"
          echo "ðŸ“„ Site: ${{ steps.get-site-url.outputs.page_url }}"