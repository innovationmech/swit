name: Update Badges

on:
  push:
    branches: [ master ]
  schedule:
    # æ¯å¤©æ›´æ–°ä¸€æ¬¡å¾½ç« 
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-badges:
    name: Update Dynamic Badges
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.24'

    - name: Install dependencies
      run: go mod download

    - name: Count Lines of Code
      id: loc
      run: |
        # è®¡ç®—ä»£ç è¡Œæ•° (æ’é™¤ç”Ÿæˆçš„ä»£ç å’Œvendor)
        LINES=$(find . -name "*.go" -not -path "./vendor/*" -not -path "./_output/*" -not -path "./api/gen/*" | xargs wc -l | tail -1 | awk '{print $1}')
        echo "lines=${LINES}" >> $GITHUB_OUTPUT
        echo "ğŸ“Š Total lines of code: ${LINES}"

    - name: Count Commits
      id: commits
      run: |
        COMMITS=$(git rev-list --count HEAD)
        echo "commits=${COMMITS}" >> $GITHUB_OUTPUT
        echo "ğŸ“ˆ Total commits: ${COMMITS}"

    - name: Get Last Commit Date
      id: last_commit
      run: |
        LAST_COMMIT=$(git log -1 --format=%cd --date=short)
        echo "last_commit=${LAST_COMMIT}" >> $GITHUB_OUTPUT
        echo "ğŸ“… Last commit: ${LAST_COMMIT}"

    - name: Count Contributors
      id: contributors
      run: |
        CONTRIBUTORS=$(git log --format='%aN' | sort -u | wc -l)
        echo "contributors=${CONTRIBUTORS}" >> $GITHUB_OUTPUT
        echo "ğŸ‘¥ Contributors: ${CONTRIBUTORS}"

    - name: Check Dependencies
      id: deps
      run: |
        # è®¡ç®—ç›´æ¥ä¾èµ–æ•°é‡
        DEPS=$(go list -m all | grep -v "^github.com/innovationmech/swit" | wc -l)
        echo "dependencies=${DEPS}" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Dependencies: ${DEPS}"

    - name: Get Latest Release
      id: release
      run: |
        # è·å–æœ€æ–°æ ‡ç­¾ä½œä¸ºç‰ˆæœ¬
        LATEST=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        echo "version=${LATEST}" >> $GITHUB_OUTPUT
        echo "ğŸ·ï¸ Latest version: ${LATEST}"

    - name: Create Badge URLs
      run: |
        # åˆ›å»ºå¾½ç«  URL æ–‡ä»¶ä¾›å‚è€ƒ
        cat > BADGE_URLS.md << EOF
        # é¡¹ç›®å¾½ç«  URLs
        
        ## è‡ªåŠ¨ç”Ÿæˆçš„å¾½ç« 
        
        ### ä»£ç ç»Ÿè®¡
        - Lines of Code: ![Lines of Code](https://img.shields.io/badge/lines_of_code-${{ steps.loc.outputs.lines }}-blue)
        - Commits: ![Commits](https://img.shields.io/badge/commits-${{ steps.commits.outputs.commits }}-green)
        - Contributors: ![Contributors](https://img.shields.io/badge/contributors-${{ steps.contributors.outputs.contributors }}-orange)
        - Dependencies: ![Dependencies](https://img.shields.io/badge/dependencies-${{ steps.deps.outputs.dependencies }}-purple)
        - Last Update: ![Last Update](https://img.shields.io/badge/last_update-${{ steps.last_commit.outputs.last_commit }}-yellow)
        - Version: ![Version](https://img.shields.io/badge/version-${{ steps.release.outputs.version }}-red)
        
        ### CI/CD çŠ¶æ€
        - CI: ![CI](https://github.com/innovationmech/swit/workflows/CI/badge.svg)
        - Security: ![Security](https://github.com/innovationmech/swit/workflows/Security%20Checks/badge.svg)
        - Coverage: [![codecov](https://codecov.io/gh/innovationmech/swit/branch/master/graph/badge.svg)](https://codecov.io/gh/innovationmech/swit)
        
        ### é¡¹ç›®ä¿¡æ¯
        - Go Report: [![Go Report Card](https://goreportcard.com/badge/github.com/innovationmech/swit)](https://goreportcard.com/report/github.com/innovationmech/swit)
        - Go Reference: [![Go Reference](https://pkg.go.dev/badge/github.com/innovationmech/swit.svg)](https://pkg.go.dev/github.com/innovationmech/swit)
        - License: [![License](https://img.shields.io/github/license/innovationmech/swit.svg)](LICENSE)
        - Issues: [![GitHub issues](https://img.shields.io/github/issues/innovationmech/swit.svg)](https://github.com/innovationmech/swit/issues)
        - Stars: [![GitHub stars](https://img.shields.io/github/stars/innovationmech/swit.svg)](https://github.com/innovationmech/swit/stargazers)
        
        ## ä½¿ç”¨æ–¹æ³•
        
        å¤åˆ¶ä»¥ä¸Šå¾½ç« ä»£ç å¹¶ç²˜è´´åˆ° README.md ä¸­ç›¸åº”ä½ç½®ã€‚
        EOF
        
        echo "ğŸ“ Generated badge URLs in BADGE_URLS.md"

    - name: Update README with dynamic badges
      run: |
        # åœ¨ README.md ä¸­æŸ¥æ‰¾å¹¶æ›´æ–°åŠ¨æ€å¾½ç« éƒ¨åˆ†
        if grep -q "<!-- DYNAMIC_BADGES_START -->" README.md; then
          echo "Found dynamic badge markers, updating..."
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨æ–°çš„å¾½ç« å†…å®¹
          cat > temp_badges.txt << 'EOF'
        <!-- DYNAMIC_BADGES_START -->
        ![Lines of Code](https://img.shields.io/badge/lines_of_code-${{ steps.loc.outputs.lines }}-blue)
        ![Commits](https://img.shields.io/badge/commits-${{ steps.commits.outputs.commits }}-green)
        ![Contributors](https://img.shields.io/badge/contributors-${{ steps.contributors.outputs.contributors }}-orange)
        ![Last Update](https://img.shields.io/badge/last_update-${{ steps.last_commit.outputs.last_commit }}-yellow)
        <!-- DYNAMIC_BADGES_END -->
        EOF
          
          # ä½¿ç”¨ awk æ›¿æ¢å†…å®¹
          awk '
          /<!-- DYNAMIC_BADGES_START -->/ {
            system("cat temp_badges.txt")
            skip = 1
            next
          }
          /<!-- DYNAMIC_BADGES_END -->/ {
            skip = 0
            next
          }
          !skip { print }
          ' README.md > README_temp.md && mv README_temp.md README.md
          
          rm temp_badges.txt
          echo "âœ… Updated dynamic badges in README.md"
        else
          echo "â„¹ï¸ No dynamic badge markers found in README.md"
          echo "ğŸ’¡ Add <!-- DYNAMIC_BADGES_START --> and <!-- DYNAMIC_BADGES_END --> markers to enable auto-update"
        fi

    - name: Commit updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet; then
          echo "No changes to commit"
        else
          git add .
          git commit -m "chore: update project badges [skip ci]"
          git push
          echo "âœ… Committed badge updates"
        fi
