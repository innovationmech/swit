name: ðŸ”„ Documentation Content Sync

on:
  push:
    branches: [master]
    paths:
      - 'README.md'
      - 'api/**'
      - 'internal/**/*.go'
      - 'pkg/**/*.go'
      - 'examples/**'
      - 'docs/README.md'
  schedule:
    # æ¯å¤©å‡Œæ™¨ 3 ç‚¹æ£€æŸ¥å†…å®¹åŒæ­¥
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      sync_type:
        description: 'Type of content to sync'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - readme
          - api
          - examples
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: false
        type: boolean

# è®¾ç½®æƒé™
permissions:
  actions: write
  contents: write
  pull-requests: write

# é˜²æ­¢å¹¶å‘æ‰§è¡Œ
concurrency:
  group: "docs-sync"
  cancel-in-progress: false

env:
  NODE_VERSION: '18'
  GO_VERSION: '1.21'
  DOCS_DIR: './docs/pages'

jobs:
  # æ£€æµ‹æºå†…å®¹å˜æ›´
  detect-source-changes:
    runs-on: ubuntu-latest
    outputs:
      readme-changed: ${{ steps.changes.outputs.readme }}
      api-changed: ${{ steps.changes.outputs.api }}
      code-changed: ${{ steps.changes.outputs.code }}
      examples-changed: ${{ steps.changes.outputs.examples }}
      force-sync: ${{ github.event.inputs.force_update == 'true' || github.event_name == 'schedule' }}
      sync-type: ${{ github.event.inputs.sync_type || 'all' }}
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ðŸ” Detect content changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            readme:
              - 'README.md'
              - 'docs/README.md'
            api:
              - 'api/**'
              - 'internal/**/*.go'
              - 'pkg/**/*.go'
            code:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
            examples:
              - 'examples/**'

  # åŒæ­¥ README å†…å®¹
  sync-readme:
    runs-on: ubuntu-latest
    needs: detect-source-changes
    if: |
      needs.detect-source-changes.outputs.readme-changed == 'true' || 
      needs.detect-source-changes.outputs.force-sync == 'true' ||
      contains(needs.detect-source-changes.outputs.sync-type, 'readme') ||
      contains(needs.detect-source-changes.outputs.sync-type, 'all')
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.DOCS_DIR }}/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: npm ci

      - name: ðŸ”„ Sync README content
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ”„ Syncing README content to documentation..."
          
          # ç¡®ä¿åŒæ­¥è„šæœ¬å­˜åœ¨
          if [ ! -f "scripts/sync-docs.js" ]; then
            echo "âŒ sync-docs.js script not found"
            exit 1
          fi
          
          # è¿è¡Œ README åŒæ­¥
          # å½“å‰ sync-docs.js ä»…æ”¯æŒå‘½ä»¤: sync|watch|helpï¼Œä¸æ”¯æŒ --source å‚æ•°
          # ä½¿ç”¨é»˜è®¤ sync æ‰§è¡Œ README ä¸Žé™„åŠ æ–‡æ¡£åŒæ­¥
          node scripts/sync-docs.js sync
          
          echo "âœ… README content sync completed"

      - name: ðŸ“Š Check README changes
        id: readme-changes
        run: |
          if [ -n "$(git status --porcelain -- docs/pages/)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ README content changes detected"
            git diff --name-only -- docs/pages/
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ No README content changes"
          fi

      - name: ðŸ’¾ Commit README changes
        if: steps.readme-changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add docs/pages/
          git commit -m "ðŸ“š Sync README content to documentation

          ðŸ”„ Auto-sync from main README.md
          ðŸ“… Updated: $(date -u)
          ðŸ¤– Generated by GitHub Actions"

  # åŒæ­¥ API æ–‡æ¡£
  sync-api-docs:
    runs-on: ubuntu-latest
    needs: detect-source-changes
    if: |
      needs.detect-source-changes.outputs.api-changed == 'true' || 
      needs.detect-source-changes.outputs.force-sync == 'true' ||
      contains(needs.detect-source-changes.outputs.sync-type, 'api') ||
      contains(needs.detect-source-changes.outputs.sync-type, 'all')
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ—ï¸ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.DOCS_DIR }}/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: npm ci

      - name: ðŸ”§ Setup API documentation tools
        run: |
          echo "ðŸ”§ Setting up API documentation tools..."
          
          # å®‰è£… Swagger/OpenAPI å·¥å…·
          go install github.com/swaggo/swag/cmd/swag@latest
          
          # éªŒè¯å·¥å…·å®‰è£…
          swag --version

      - name: ðŸ“‹ Generate API documentation
        run: |
          echo "ðŸ“‹ Generating API documentation..."
          
          # ç”Ÿæˆ Swagger æ–‡æ¡£
          if [ -d "cmd/swit-serve" ]; then
            cd cmd/swit-serve
            echo "Generating swagger for swit-serve..."
            swag init -g swit-serve.go -o ../../api/swagger/switserve --parseDependency --parseInternal || echo "âš  swag init swit-serve failed"
            cd ../..
          fi

          if [ -d "cmd/swit-auth" ]; then
            cd cmd/swit-auth
            echo "Generating swagger for swit-auth..."
            swag init -g swit-auth.go -o ../../api/swagger/switauth --parseDependency --parseInternal || echo "âš  swag init swit-auth failed"
            cd ../..
          fi

          # è‹¥éœ€è¦æ›´å¤æ‚é€»è¾‘å¯æ”¹ç”¨ scripts/tools/swagger-manage.sh
          
          echo "âœ… API documentation generated"

      - name: ðŸ”„ Process API documentation
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ”„ Processing API documentation for website..."
          
          # è¿è¡Œ API æ–‡æ¡£å¤„ç†è„šæœ¬
          if [ -f "scripts/api-docs-generator.js" ]; then
            # åŽ»é™¤ä¸å—æ”¯æŒçš„ --verbose å‚æ•°ï¼ŒæŒ‰è„šæœ¬é»˜è®¤è¡Œä¸ºè¿è¡Œ
            node scripts/api-docs-generator.js
          else
            echo "âš ï¸ API docs generator script not found"
          fi
          
          echo "âœ… API documentation processing completed"

      - name: ðŸ“Š Check API documentation changes
        id: api-changes
        run: |
          if [ -n "$(git status --porcelain -- docs/pages/ api/)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ API documentation changes detected"
            git diff --name-only -- docs/pages/ api/
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ No API documentation changes"
          fi

      - name: ðŸ’¾ Commit API documentation changes
        if: steps.api-changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add docs/pages/ api/
          git commit -m "ðŸ“‹ Update API documentation

          ðŸ”„ Auto-generated from source code
          ðŸ“… Updated: $(date -u)
          ðŸ¤– Generated by GitHub Actions"

  # åŒæ­¥ç¤ºä¾‹ä»£ç 
  sync-examples:
    runs-on: ubuntu-latest
    needs: detect-source-changes
    if: |
      needs.detect-source-changes.outputs.examples-changed == 'true' || 
      needs.detect-source-changes.outputs.force-sync == 'true' ||
      contains(needs.detect-source-changes.outputs.sync-type, 'examples') ||
      contains(needs.detect-source-changes.outputs.sync-type, 'all')
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.DOCS_DIR }}/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: npm ci

      - name: ðŸ”„ Sync example code
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ”„ Syncing example code to documentation..."
          
          # è¿è¡Œç¤ºä¾‹ä»£ç åŒæ­¥
          if [ -f "scripts/sync-docs.js" ]; then
            # ä»…åŒæ­¥ç¤ºä¾‹ (è„šæœ¬å·²æ”¯æŒ examples å­å‘½ä»¤/--source=examples)
            node scripts/sync-docs.js examples
          else
            echo "âš ï¸ Sync script not found"
          fi
          
          echo "âœ… Example code sync completed"

      - name: ðŸ“Š Check example changes
        id: example-changes
        run: |
          if [ -n "$(git status --porcelain -- docs/pages/)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Example code changes detected"
            git diff --name-only -- docs/pages/
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ðŸ“ No example code changes"
          fi

      - name: ðŸ’¾ Commit example changes
        if: steps.example-changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add docs/pages/
          git commit -m "ðŸ“˜ Update example code documentation

          ðŸ”„ Auto-sync from examples directory
          ðŸ“… Updated: $(date -u)
          ðŸ¤– Generated by GitHub Actions"

  # å†…å®¹éªŒè¯å’Œè´¨é‡æ£€æŸ¥
  validate-content:
    runs-on: ubuntu-latest
    needs: [sync-readme, sync-api-docs, sync-examples]
    if: always() && (needs.sync-readme.result == 'success' || needs.sync-api-docs.result == 'success' || needs.sync-examples.result == 'success')
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.DOCS_DIR }}/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: npm ci

      - name: ðŸ” Validate documentation content
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ” Validating documentation content..."
          
          # è¿è¡Œå†…å®¹éªŒè¯
          if [ -f "scripts/content-validator.js" ]; then
            node scripts/content-validator.js
          fi
          
          # æ£€æŸ¥ Markdown æ ¼å¼
          if command -v markdownlint &> /dev/null; then
            markdownlint "**/*.md" --config .markdownlint.json || echo "âš ï¸ Markdown lint issues found"
          fi
          
          # æ£€æŸ¥å†…éƒ¨é“¾æŽ¥
          if npm run validate:links --if-present; then
            echo "âœ… Link validation passed"
          else
            echo "âš ï¸ Link validation not available"
          fi
          
          echo "âœ… Content validation completed"

      - name: ðŸ“Š Generate content report
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ðŸ“Š Generating content sync report..."
          
          # ç”Ÿæˆå†…å®¹ç»Ÿè®¡
          cat > content-sync-report.md << EOF
          # Documentation Content Sync Report
          
          **Generated**: $(date -u)
          **Triggered by**: ${{ github.event_name }}
          **Commit**: ${{ github.sha }}
          
          ## Content Statistics
          
          ### Markdown Files
          \`\`\`
          $(find . -name "*.md" -not -path "./node_modules/*" | wc -l) total files
          $(find . -name "*.md" -not -path "./node_modules/*" -exec wc -l {} + | tail -1 | awk '{print $1}') total lines
          \`\`\`
          
          ### API Documentation
          \`\`\`
          $(find . -path "*/api/*" -name "*.md" | wc -l) API doc files
          \`\`\`
          
          ### Example Code
          \`\`\`
          $(find . -path "*/examples/*" -name "*.md" | wc -l) example files
          \`\`\`
          
          ## Recent Changes
          
          ### Sync Jobs Status
          - README Sync: ${{ needs.sync-readme.result || 'skipped' }}
          - API Docs Sync: ${{ needs.sync-api-docs.result || 'skipped' }}
          - Examples Sync: ${{ needs.sync-examples.result || 'skipped' }}
          EOF
          
          echo "ðŸ“„ Content report generated"

      - name: ðŸ“¤ Upload content report
        uses: actions/upload-artifact@v5
        with:
          name: content-sync-report
          path: '${{ env.DOCS_DIR }}/content-sync-report.md'

  # æŽ¨é€æ‰€æœ‰æ›´æ”¹
  push-changes:
    runs-on: ubuntu-latest
    needs: [sync-readme, sync-api-docs, sync-examples, validate-content]
    if: always() && (needs.sync-readme.result == 'success' || needs.sync-api-docs.result == 'success' || needs.sync-examples.result == 'success')
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ðŸ”„ Pull latest changes
        run: |
          echo "ðŸ”„ Pulling latest changes..."
          git pull origin master --rebase || true

      - name: ðŸ“¤ Push synchronized content
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "ðŸ“¤ Pushing synchronized content..."
            git push origin master
            echo "âœ… Content synchronization completed and pushed"
          else
            echo "ðŸ“ No changes to push"
          fi

  # è§¦å‘æ–‡æ¡£é‡æ–°éƒ¨ç½²
  trigger-deploy:
    runs-on: ubuntu-latest
    needs: push-changes
    # ä»…åœ¨éž PR äº‹ä»¶è¿è¡Œï¼Œé¿å… fork PR ä¸Šçš„ GITHUB_TOKEN æƒé™å—é™å¯¼è‡´ 403
    if: needs.push-changes.result == 'success' && github.event_name != 'pull_request'
    permissions:
      actions: write
    steps:
      - name: ðŸš€ Trigger documentation deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'docs-deploy.yml',
                ref: 'master',
                inputs: {
                  environment: 'production',
                  force_sync: 'false'
                }
              });
              console.log('ðŸš€ Documentation deployment triggered');
            } catch (err) {
              core.warning(`Failed to trigger docs-deploy: ${err?.status} ${err?.message}`);
              core.warning('Ensure: 1) This job is not running on a fork PR, 2) GITHUB_TOKEN has actions: write (workflow permissions set to Read and write), 3) docs-deploy.yml has workflow_dispatch.');
              throw err;
            }

  # å‘é€åŒæ­¥æŠ¥å‘Š
  send-sync-report:
    runs-on: ubuntu-latest
    needs: [detect-source-changes, sync-readme, sync-api-docs, sync-examples, validate-content, push-changes]
    if: always()
    steps:
      - name: ðŸ“Š Generate sync summary
        run: |
          echo "ðŸ“Š Documentation Content Sync Summary"
          echo "======================================"
          echo "ðŸ• Completed at: $(date -u)"
          echo "ðŸ”„ Trigger: ${{ github.event_name }}"
          echo ""
          echo "ðŸ“‹ Job Results:"
          echo "  README Sync: ${{ needs.sync-readme.result || 'skipped' }}"
          echo "  API Docs Sync: ${{ needs.sync-api-docs.result || 'skipped' }}"
          echo "  Examples Sync: ${{ needs.sync-examples.result || 'skipped' }}"
          echo "  Content Validation: ${{ needs.validate-content.result || 'skipped' }}"
          echo "  Push Changes: ${{ needs.push-changes.result || 'skipped' }}"
          echo ""
          echo "ðŸ”— Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: ðŸ”” Notify on failure
        if: failure()
        run: |
          echo "âŒ Content synchronization failed!"
          echo "Please check the workflow logs for details."
          # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥åˆ° Slackã€Discord æˆ–é‚®ä»¶

      - name: ðŸŽ‰ Notify on success
        if: success()
        run: |
          echo "âœ… Content synchronization completed successfully!"
          echo "ðŸ“š Documentation is now up to date."