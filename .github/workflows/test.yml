name: Test Suite

on:
  push:
    branches: [ master, dev ]
    paths:
      - 'go.mod'
      - 'go.sum'
      - '**/*.go'
      - 'api/**'
      - 'cmd/**'
      - 'internal/**'
      - 'pkg/**'
      - '.github/workflows/test.yml'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [ master, dev ]
    paths:
      - 'go.mod'
      - 'go.sum'
      - '**/*.go'
      - 'api/**'
      - 'cmd/**'
      - 'internal/**'
      - 'pkg/**'
      - '.github/workflows/test.yml'
      - '.github/workflows/ci.yml'
  workflow_dispatch:
  workflow_call:  # å…è®¸è¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨

# ç¡®ä¿åŒä¸€åˆ†æ”¯çš„å·¥ä½œæµä¸ä¼šå¹¶è¡Œè¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  # æµ‹è¯•è¦†ç›–çŽ‡æœ€ä½Žè¦æ±‚ï¼ˆåˆå§‹å€¼ï¼ŒåŽç»­é€æ­¥æé«˜åˆ° 85%ï¼‰
  MIN_COVERAGE: 65

jobs:
  # å¿«é€Ÿæµ‹è¯• - æœ€å¿«åé¦ˆï¼ˆä½¿ç”¨ -short æ ‡å¿—ï¼‰
  quick-tests:
    name: Quick Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          check-latest: true
          cache: true
          cache-dependency-path: '**/go.sum'

      - name: Cache tools
        uses: actions/cache@v5
        with:
          path: |
            ~/.local/bin/
            ~/go/bin/
          key: ${{ runner.os }}-go-tools-${{ hashFiles('Makefile', 'scripts/**', 'go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-tools-

      - name: Install dev tools
        run: make setup-dev

      - name: Generate proto code
        run: make proto-dev

      - name: Run quick tests
        run: make test-dev

  # å•å…ƒæµ‹è¯•çŸ©é˜µ - å¤š Go ç‰ˆæœ¬å¹¶è¡Œæµ‹è¯•
  unit-tests:
    name: Unit Tests (Go ${{ matrix.go-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        go-version: ['1.24']
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
          check-latest: true
          cache: true
          cache-dependency-path: '**/go.sum'

      - name: Cache tools
        uses: actions/cache@v5
        with:
          path: |
            ~/.local/bin/
            ~/go/bin/
          key: ${{ runner.os }}-go-tools-${{ hashFiles('Makefile', 'scripts/**', 'go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-tools-

      - name: Install dev tools
        run: make setup-dev

      - name: Generate proto code
        run: make proto-dev

      - name: Run unit tests
        run: make test-advanced TYPE=unit PACKAGE=all

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v7
        with:
          name: test-results-go${{ matrix.go-version }}
          path: |
            **/test-report.xml
            **/test-output.log
          retention-days: 7

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          check-latest: true
          cache: true
          cache-dependency-path: '**/go.sum'

      - name: Cache tools
        uses: actions/cache@v5
        with:
          path: |
            ~/.local/bin/
            ~/go/bin/
          key: ${{ runner.os }}-go-tools-${{ hashFiles('Makefile', 'scripts/**', 'go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-tools-

      - name: Install dev tools
        run: make setup-dev

      - name: Generate proto code
        run: make proto-dev

      - name: Run integration tests
        run: |
          # è¿è¡Œå¸¦æœ‰ integration æ ‡ç­¾çš„æµ‹è¯•ï¼ˆå¦‚æžœæ²¡æœ‰åˆ™è·³è¿‡ï¼‰
          if go list -tags=integration ./... 2>/dev/null | grep -q .; then
            echo "Running integration tests..."
            go test -v -tags=integration ./pkg/... ./internal/... -timeout 10m || echo "Some integration tests require external services and were skipped"
          else
            echo "No integration tests found with 'integration' tag. Running all tests..."
            make test-dev
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v7
        with:
          name: integration-test-results
          path: |
            **/test-report.xml
            **/test-output.log
          retention-days: 7

  # ç«žæ€æ£€æµ‹æµ‹è¯•
  race-detection:
    name: Race Detection
    runs-on: ubuntu-latest
    continue-on-error: true  # å…è®¸ç«žæ€æ£€æµ‹å¤±è´¥ä½†ä¸é˜»æ­¢ PR
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          check-latest: true
          cache: true
          cache-dependency-path: '**/go.sum'

      - name: Cache tools
        uses: actions/cache@v5
        with:
          path: |
            ~/.local/bin/
            ~/go/bin/
          key: ${{ runner.os }}-go-tools-${{ hashFiles('Makefile', 'scripts/**', 'go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-tools-

      - name: Install dev tools
        run: make setup-dev

      - name: Generate proto code
        run: make proto-dev

      - name: Run race detection
        continue-on-error: true
        run: |
          echo "Running race detection tests..."
          make test-advanced TYPE=race PACKAGE=all || {
            echo "âš ï¸ Some race detection tests failed. This is informational and won't block the PR."
            echo "Please review the failures and fix them in a follow-up if necessary."
            exit 0
          }

  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  benchmark-tests:
    name: Benchmark Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          check-latest: true
          cache: true
          cache-dependency-path: '**/go.sum'

      - name: Cache tools
        uses: actions/cache@v5
        with:
          path: |
            ~/.local/bin/
            ~/go/bin/
          key: ${{ runner.os }}-go-tools-${{ hashFiles('Makefile', 'scripts/**', 'go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-tools-

      - name: Install dev tools
        run: make setup-dev

      - name: Generate proto code
        run: make proto-dev

      - name: Run benchmark tests
        run: |
          make test-advanced TYPE=bench PACKAGE=all | tee benchmark-output.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v7
        with:
          name: benchmark-results
          path: benchmark-output.txt
          retention-days: 30

      - name: Compare benchmarks
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        continue-on-error: true
        run: |
          # ä¸‹è½½ä¹‹å‰çš„åŸºå‡†æµ‹è¯•ç»“æžœå¹¶æ¯”è¾ƒ
          echo "Benchmark comparison would go here"

  # æµ‹è¯•è¦†ç›–çŽ‡
  coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          check-latest: true
          cache: true
          cache-dependency-path: '**/go.sum'

      - name: Cache tools
        uses: actions/cache@v5
        with:
          path: |
            ~/.local/bin/
            ~/go/bin/
          key: ${{ runner.os }}-go-tools-${{ hashFiles('Makefile', 'scripts/**', 'go.mod') }}
          restore-keys: |
            ${{ runner.os }}-go-tools-

      - name: Install dev tools
        run: make setup-dev

      - name: Generate proto code
        run: make proto-dev

      - name: Run tests with coverage
        run: make test-coverage

      - name: Check coverage threshold
        id: coverage-check
        run: |
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}' || echo "0")
          echo "coverage=${COVERAGE}" >> $GITHUB_OUTPUT
          echo "Total coverage: ${COVERAGE}%"
          
          # è½¬æ¢ä¸ºæ•´æ•°è¿›è¡Œæ¯”è¾ƒ
          COVERAGE_INT=$(echo "$COVERAGE" | cut -d. -f1)
          if [ "$COVERAGE_INT" -lt "$MIN_COVERAGE" ]; then
            echo "âŒ Coverage ${COVERAGE}% is below minimum threshold ${MIN_COVERAGE}%"
            exit 1
          else
            echo "âœ… Coverage ${COVERAGE}% meets minimum threshold ${MIN_COVERAGE}%"
          fi

      - name: Generate package-level coverage report
        id: package-coverage
        run: |
          mkdir -p _output/coverage
          
          # Generate detailed package coverage report
          go tool cover -func=coverage.out > _output/coverage/coverage-by-func.txt
          
          # Generate package summary
          echo "## Package Coverage Summary" > _output/coverage/package-summary.md
          echo "" >> _output/coverage/package-summary.md
          echo "| Package | Coverage |" >> _output/coverage/package-summary.md
          echo "|---------|----------|" >> _output/coverage/package-summary.md
          
          # Extract package-level coverage
          go tool cover -func=coverage.out | grep -E "^[a-z]" | \
            awk '{
              split($1, path, ":")
              pkg = path[1]
              gsub(/.*\/swit\//, "", pkg)
              coverage[pkg] += 1
              if ($NF ~ /%/) {
                pct = substr($NF, 1, length($NF)-1)
                if (pct > max[pkg] || max[pkg] == "") max[pkg] = pct
              }
            }
            END {
              for (pkg in coverage) {
                if (max[pkg] != "") printf "| %s | %s%% |\n", pkg, max[pkg]
              }
            }' | sort >> _output/coverage/package-summary.md
          
          # Calculate coverage for key packages
          PKG_COVERAGE=$(go tool cover -func=coverage.out | grep "pkg/server" | tail -1 | awk '{print $3}' || echo "N/A")
          echo "pkg_server_coverage=${PKG_COVERAGE}" >> $GITHUB_OUTPUT
          
          TRANSPORT_COVERAGE=$(go tool cover -func=coverage.out | grep "pkg/transport" | tail -1 | awk '{print $3}' || echo "N/A")
          echo "pkg_transport_coverage=${TRANSPORT_COVERAGE}" >> $GITHUB_OUTPUT
          
          SECURITY_COVERAGE=$(go tool cover -func=coverage.out | grep "pkg/security" | tail -1 | awk '{print $3}' || echo "N/A")
          echo "pkg_security_coverage=${SECURITY_COVERAGE}" >> $GITHUB_OUTPUT

      - name: Generate coverage summary
        run: |
          echo "## ðŸ“Š Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Coverage**: ${{ steps.coverage-check.outputs.coverage }}%" >> $GITHUB_STEP_SUMMARY
          echo "**Minimum Required**: ${{ env.MIN_COVERAGE }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Key Package Coverage" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| pkg/server | ${{ steps.package-coverage.outputs.pkg_server_coverage }} |" >> $GITHUB_STEP_SUMMARY
          echo "| pkg/transport | ${{ steps.package-coverage.outputs.pkg_transport_coverage }} |" >> $GITHUB_STEP_SUMMARY
          echo "| pkg/security | ${{ steps.package-coverage.outputs.pkg_security_coverage }} |" >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@af09b5e394c93991b95a5e7646aeb90c1917f78f # v5.5.1
        with:
          files: ./coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v7
        with:
          name: coverage-report
          path: |
            coverage.out
            coverage.html
            _output/coverage/
          retention-days: 30

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = parseFloat('${{ steps.coverage-check.outputs.coverage }}');
            const minCoverage = parseFloat('${{ env.MIN_COVERAGE }}');
            
            let emoji = 'âœ…';
            let status = 'Good coverage!';
            let color = 'ðŸŸ¢';
            
            if (coverage < minCoverage) {
              emoji = 'âŒ';
              status = `Coverage is below minimum threshold (${minCoverage}%)`;
              color = 'ðŸ”´';
            } else if (coverage >= 80) {
              emoji = 'âœ…';
              status = 'Excellent coverage!';
              color = 'ðŸŸ¢';
            } else if (coverage >= minCoverage) {
              emoji = 'âœ…';
              status = 'Good coverage! Consider improving further.';
              color = 'ðŸŸ¡';
            }
            
            const body = `## ðŸ“Š Test Coverage Report
            
            ${color} **Total Coverage**: ${coverage.toFixed(2)}%
            **Minimum Required**: ${minCoverage}%
            
            ${emoji} ${status}
            
            ---
            *Coverage report generated by GitHub Actions*`;
            
            // æŸ¥æ‰¾çŽ°æœ‰çš„è¦†ç›–çŽ‡è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const existingComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Test Coverage Report')
            );
            
            if (existingComment) {
              // æ›´æ–°çŽ°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

  # æµ‹è¯•æŠ¥å‘Šæ±‡æ€»
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [quick-tests, unit-tests, integration-tests, race-detection, coverage]
    if: always()
    steps:
      - name: Check test results
        run: |
          # ç«žæ€æ£€æµ‹æ˜¯å¯é€‰çš„ï¼Œä¸ä¼šå¯¼è‡´æ•´ä½“å¤±è´¥
          RACE_STATUS="${{ needs.race-detection.result }}"
          if [[ "$RACE_STATUS" != "success" ]]; then
            echo "âš ï¸ Race Detection: $RACE_STATUS (informational only)"
          fi
          
          # æ£€æŸ¥å…³é”®æµ‹è¯•
          if [[ "${{ needs.quick-tests.result }}" == "success" && \
                "${{ needs.unit-tests.result }}" == "success" && \
                "${{ needs.integration-tests.result }}" == "success" && \
                "${{ needs.coverage.result }}" == "success" ]]; then
            echo "âœ… All critical tests passed!"
            echo "Quick Tests: ${{ needs.quick-tests.result }}"
            echo "Unit Tests: ${{ needs.unit-tests.result }}"
            echo "Integration Tests: ${{ needs.integration-tests.result }}"
            echo "Coverage: ${{ needs.coverage.result }}"
            echo "Race Detection: $RACE_STATUS (optional)"
            exit 0
          else
            echo "âŒ Some critical tests failed!"
            echo "Quick Tests: ${{ needs.quick-tests.result }}"
            echo "Unit Tests: ${{ needs.unit-tests.result }}"
            echo "Integration Tests: ${{ needs.integration-tests.result }}"
            echo "Race Detection: $RACE_STATUS (optional)"
            echo "Coverage: ${{ needs.coverage.result }}"
            exit 1
          fi

      - name: Post summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const quickTests = '${{ needs.quick-tests.result }}';
            const unitTests = '${{ needs.unit-tests.result }}';
            const integrationTests = '${{ needs.integration-tests.result }}';
            const raceDetection = '${{ needs.race-detection.result }}';
            const coverage = '${{ needs.coverage.result }}';
            
            const getEmoji = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'failure') return 'âŒ';
              if (status === 'skipped') return 'â­ï¸';
              return 'âš ï¸';
            };
            
            const getRaceNote = (status) => {
              if (status !== 'success') {
                return ' (informational)';
              }
              return '';
            };
            
            const body = `## ðŸ§ª Test Suite Summary
            
            | Test Type | Status | Description |
            |-----------|--------|-------------|
            | Quick Tests | ${getEmoji(quickTests)} ${quickTests} | Fast feedback (< 1 min) |
            | Unit Tests (Multi-version) | ${getEmoji(unitTests)} ${unitTests} | Go 1.24 |
            | Integration Tests | ${getEmoji(integrationTests)} ${integrationTests} | End-to-end scenarios |
            | Test Coverage | ${getEmoji(coverage)} ${coverage} | Minimum 65% required |
            | Race Detection | ${getEmoji(raceDetection)} ${raceDetection}${getRaceNote(raceDetection)} | Concurrency issues |
            
            ${raceDetection !== 'success' ? '> â„¹ï¸ **Note**: Race detection failures are informational and don\'t block PR merging.\n' : ''}
            ---
            *Test summary generated by GitHub Actions*`;
            
            // æŸ¥æ‰¾çŽ°æœ‰çš„æµ‹è¯•æ‘˜è¦è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const existingComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Test Suite Summary')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

