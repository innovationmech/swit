# Copyright 2024 Swit Authors
# SPDX-License-Identifier: Apache-2.0
#
# Release Workflow
# This workflow handles automated releases with security scanning
# Ref: Issue #831 - CI/CD ç®¡é“é›†æˆ

name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        default: false
        type: boolean
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write
  security-events: write
  id-token: write

env:
  GO_VERSION: '1.24'
  REGISTRY: ghcr.io

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ===========================================================================
  # Pre-release Validation
  # ===========================================================================
  validate:
    name: Pre-release Validation
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
            # Check if it's a pre-release (contains - like v1.0.0-alpha.1)
            if [[ "$VERSION" == *"-"* ]]; then
              IS_PRERELEASE="true"
            else
              IS_PRERELEASE="false"
            fi
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "is_prerelease=${IS_PRERELEASE}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Release version: ${VERSION}"
          echo "ðŸ·ï¸ Pre-release: ${IS_PRERELEASE}"

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "âŒ Invalid version format: ${VERSION}"
            echo "Expected format: vX.Y.Z or vX.Y.Z-suffix"
            exit 1
          fi
          echo "âœ… Version format is valid"

  # ===========================================================================
  # Security Scan (Pre-release)
  # ===========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true
          cache-dependency-path: '**/go.sum'

      - name: Install dependencies
        run: go mod download

      - name: Install dev tools
        run: make setup-dev

      - name: Generate proto code
        run: make proto

      - name: Run gosec
        run: |
          go install github.com/securego/gosec/v2/cmd/gosec@latest
          PACKAGES=$(go list ./... | grep -v -E '/(api/gen|docs/generated)/')
          gosec $PACKAGES || echo "âš ï¸ Gosec found issues (non-blocking for release)"

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          PACKAGES=$(go list ./... | grep -v -E '/(api/gen|docs/generated)/')
          govulncheck $PACKAGES || {
            echo "âš ï¸ Govulncheck found vulnerabilities"
            echo "Please review and address before production deployment"
          }

      - name: Security scan summary
        run: |
          echo "## ðŸ”’ Pre-release Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Security scans completed for release ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Run Tests
  # ===========================================================================
  tests:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true
          cache-dependency-path: '**/go.sum'

      - name: Install dev tools
        run: make setup-dev

      - name: Generate proto code
        run: make proto

      - name: Run tests
        run: make test

      - name: Run quality checks
        run: make quality

  # ===========================================================================
  # Build Release Artifacts
  # ===========================================================================
  build:
    name: Build Release
    runs-on: ubuntu-latest
    needs: [validate, security-scan, tests]
    if: |
      always() && 
      needs.validate.result == 'success' && 
      needs.security-scan.result == 'success' &&
      (needs.tests.result == 'success' || needs.tests.result == 'skipped')
    outputs:
      artifacts_uploaded: ${{ steps.build.outputs.artifacts_uploaded }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true
          cache-dependency-path: '**/go.sum'

      - name: Install dev tools
        run: make setup-dev

      - name: Generate proto code
        run: make proto

      - name: Build binaries
        id: build
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          # Build for multiple platforms
          echo "ðŸ”¨ Building release binaries for ${VERSION}..."
          
          # Create output directory
          mkdir -p _output/release
          
          # Build for Linux amd64
          GOOS=linux GOARCH=amd64 make build-dev
          for bin in bin/*; do
            if [ -f "$bin" ]; then
              name=$(basename "$bin")
              mv "$bin" "_output/release/${name}-linux-amd64"
            fi
          done
          
          # Build for Linux arm64
          GOOS=linux GOARCH=arm64 make build-dev
          for bin in bin/*; do
            if [ -f "$bin" ]; then
              name=$(basename "$bin")
              mv "$bin" "_output/release/${name}-linux-arm64"
            fi
          done
          
          # Build for Darwin amd64
          GOOS=darwin GOARCH=amd64 make build-dev
          for bin in bin/*; do
            if [ -f "$bin" ]; then
              name=$(basename "$bin")
              mv "$bin" "_output/release/${name}-darwin-amd64"
            fi
          done
          
          # Build for Darwin arm64
          GOOS=darwin GOARCH=arm64 make build-dev
          for bin in bin/*; do
            if [ -f "$bin" ]; then
              name=$(basename "$bin")
              mv "$bin" "_output/release/${name}-darwin-arm64"
            fi
          done
          
          # Build for Windows amd64
          GOOS=windows GOARCH=amd64 make build-dev
          for bin in bin/*; do
            if [ -f "$bin" ]; then
              name=$(basename "$bin")
              mv "$bin" "_output/release/${name}-windows-amd64.exe"
            fi
          done
          
          echo "âœ… Build completed"
          ls -la _output/release/
          echo "artifacts_uploaded=true" >> $GITHUB_OUTPUT

      - name: Generate checksums
        run: |
          cd _output/release
          sha256sum * > checksums.txt
          echo "ðŸ“ Checksums:"
          cat checksums.txt

      - name: Upload release artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-binaries
          path: _output/release/
          retention-days: 7

  # ===========================================================================
  # Create GitHub Release
  # ===========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: needs.build.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download release artifacts
        uses: actions/download-artifact@v7
        with:
          name: release-binaries
          path: _output/release/

      - name: Check for release notes
        id: release_notes
        run: |
          if [ -f "RELEASE_NOTES.md" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          
          # Try to get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            echo "## What's Changed" > _output/changelog.md
            echo "" >> _output/changelog.md
            git log --pretty=format:"* %s (%h)" ${PREV_TAG}..HEAD >> _output/changelog.md
          else
            echo "## Initial Release" > _output/changelog.md
            echo "" >> _output/changelog.md
            echo "First release of the project." >> _output/changelog.md
          fi
          
          echo "" >> _output/changelog.md
          echo "---" >> _output/changelog.md
          echo "" >> _output/changelog.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${VERSION}" >> _output/changelog.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ needs.validate.outputs.version }}
          tag_name: ${{ needs.validate.outputs.version }}
          body_path: ${{ steps.release_notes.outputs.exists == 'true' && 'RELEASE_NOTES.md' || '_output/changelog.md' }}
          draft: false
          prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
          files: |
            _output/release/*
            CHANGELOG.md
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## ðŸŽ‰ Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release**: ${{ needs.validate.outputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -la _output/release/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Build and Push Docker Images
  # ===========================================================================
  docker:
    name: Docker Images
    runs-on: ubuntu-latest
    needs: [validate, release]
    strategy:
      fail-fast: false
      matrix:
        service:
          - swit-serve
          - swit-auth
          - switctl
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }}
          tags: |
            type=semver,pattern={{version}},value=${{ needs.validate.outputs.version }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.validate.outputs.version }}
            type=semver,pattern={{major}},value=${{ needs.validate.outputs.version }}
            type=raw,value=latest,enable=${{ needs.validate.outputs.is_prerelease != 'true' }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: build/docker/${{ matrix.service }}.Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ needs.validate.outputs.version }}
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: '${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }}:${{ needs.validate.outputs.version }}'
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service }}.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results-${{ matrix.service }}.sarif'
          category: 'trivy-${{ matrix.service }}'
        continue-on-error: true

      - name: Docker image summary
        run: |
          echo "## ðŸ³ Docker Image: ${{ matrix.service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image**: \`${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.service }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tags" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Post-release Notifications
  # ===========================================================================
  notify:
    name: Release Notification
    runs-on: ubuntu-latest
    needs: [validate, release, docker]
    if: always() && needs.release.result == 'success'
    steps:
      - name: Generate release summary
        run: |
          echo "## ðŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-release**: ${{ needs.validate.outputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL**: https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Image |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| swit-serve | \`${{ env.REGISTRY }}/${{ github.repository }}/swit-serve:${{ needs.validate.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| swit-auth | \`${{ env.REGISTRY }}/${{ github.repository }}/swit-auth:${{ needs.validate.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| switctl | \`${{ env.REGISTRY }}/${{ github.repository }}/switctl:${{ needs.validate.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Release completed at $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY
