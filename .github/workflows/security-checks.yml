name: Security Checks

on:
  push:
    branches: [ master, dev ]
  pull_request:
    branches: [ master, dev ]

# Ê∑ªÂä†ÊùÉÈôêÈÖçÁΩÆÔºåÂÖÅËÆ∏‰∏ä‰º†ÂÆâÂÖ®Êâ´ÊèèÁªìÊûú
permissions:
  contents: read
  security-events: write
  actions: read

env:
  GO_VERSION: '1.24'

jobs:
  # ÈÄöÁî®ÂÆâÂÖ®Êâ´ÊèèÊ£ÄÊü•
  vulnerability-scan:
    name: Vulnerability Scan
    runs-on: ubuntu-latest
    env:
      TRIVY_DISABLE_VEX_NOTICE: true
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@0.33.1
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        severity: 'CRITICAL,HIGH'
        exit-code: '1'
      continue-on-error: false
        
    - name: Run Trivy for dependency check (allow failure)
      uses: aquasecurity/trivy-action@0.33.1
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'json'
        output: 'trivy-results.json'
        severity: 'CRITICAL,HIGH'
      continue-on-error: true
        
    # ÁÆÄÂçïÁöÑÂÆâÂÖ®Êä•ÂëäËæìÂá∫Ôºå‰∏çÈúÄË¶ÅÁâπÊÆäÊùÉÈôê
    - name: Display security scan summary
      run: |
        echo "üîí Security scan completed"
        if [ -f trivy-results.json ]; then
          echo "üìä Results saved to trivy-results.json"
          # ËÆ°ÁÆóÂèëÁé∞ÁöÑÊºèÊ¥ûÊï∞Èáè
          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json 2>/dev/null || echo "0")
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json 2>/dev/null || echo "0")
          echo "üö® Found $CRITICAL critical and $HIGH high severity vulnerabilities"
          
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "‚ö†Ô∏è  Security vulnerabilities detected. Please review the scan results."
            echo "üìã Detailed vulnerabilities:"
            jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH") | "- \(.Severity): \(.VulnerabilityID) in \(.PkgName) (\(.InstalledVersion) -> \(.FixedVersion // "no fix"))"' trivy-results.json 2>/dev/null || echo "Details unavailable"
          else
            echo "‚úÖ No critical or high severity vulnerabilities found"
          fi
        fi

  # Go ËØ≠Ë®ÄÁâπÂÆöÁöÑÂÆâÂÖ®Ê£ÄÊü•
  go-security-scan:
    name: Go Security Scan
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install dependencies
      run: go mod download

    # Â∞ùËØïÊÅ¢Â§ç CI Â∑•‰ΩúÊµÅÁîüÊàêÁöÑ‰ª£Á†ÅÁºìÂ≠ò
    - name: Restore generated code cache
      uses: actions/cache@v4
      with:
        path: |
          api/gen/
          docs/
          ~/.local/bin/
          ~/go/bin/
        key: ${{ runner.os }}-generated-${{ hashFiles('api/proto/**/*.proto', 'buf.yaml', 'buf.gen.yaml', 'Makefile') }}
        restore-keys: |
          ${{ runner.os }}-generated-

    # Âè™Âú®ÁºìÂ≠òÊú™ÂëΩ‰∏≠Êó∂ÈáçÊñ∞ÁîüÊàê‰ª£Á†Å
    - name: Install Proto tools
      run: |
        if [ ! -f "$HOME/.local/bin/protoc" ] || [ ! -f "$HOME/.local/bin/buf" ]; then
          make proto-setup
        fi

    - name: Install Swagger tools  
      run: |
        if [ ! -d "docs" ] || [ ! -f "$HOME/go/bin/swag" ]; then
          make swagger-setup
        fi

    - name: Generate proto code
      run: |
        # Always generate proto code to ensure it's up to date
        make proto

    - name: Generate swagger docs
      run: |
        if [ ! -d "docs" ]; then
          make swagger
        fi
        
    - name: Run govulncheck
      run: |
        go install golang.org/x/vuln/cmd/govulncheck@latest
        # Ëé∑ÂèñÊâÄÊúâÂåÖÔºåÊéíÈô§Ëá™Âä®ÁîüÊàêÁöÑ‰ª£Á†Å
        PACKAGES=$(go list ./... | grep -v -E '/(api/gen|docs/generated)/')
        
        if [ -z "$PACKAGES" ]; then
          echo "No packages to check for vulnerabilities"
          exit 0
        fi
        
        echo "Checking packages for vulnerabilities:"
        echo "$PACKAGES"
        govulncheck $PACKAGES
        
    - name: Install and run gosec
      run: |
        # ËÆæÁΩÆ Go ÁéØÂ¢É
        export GOPATH=~/go
        export PATH=$PATH:$GOPATH/bin
        mkdir -p $GOPATH/bin
        
        # ‰ΩøÁî®Ê≠£Á°ÆÁöÑÂåÖË∑ØÂæÑÂÆâË£Ö gosecÔºàÂèÇËÄÉ quality.mkÔºâ
        echo "Installing gosec via go install..."
        if go install github.com/securego/gosec/v2/cmd/gosec@latest; then
          echo "‚úÖ gosec installed successfully via go install"
        else
          echo "‚ö†Ô∏è go install failed, trying fallback method..."
          # ÂêéÂ§áÊñπÊ°àÔºö‰ΩøÁî®ÂÆòÊñπÂÆâË£ÖËÑöÊú¨Ôºà‰ΩøÁî®Ê≠£Á°ÆÁöÑÁªÑÁªáÂêçÁß∞Ôºâ
          if curl -sfL https://raw.githubusercontent.com/securego/gosec/master/install.sh | sh -s -- -b $GOPATH/bin latest; then
            echo "‚úÖ gosec installed via official script"
          else
            echo "‚ùå All installation methods failed, creating fallback"
            # ÂàõÂª∫‰∏Ä‰∏™ÁÆÄÂçïÁöÑfallbackËÑöÊú¨
            echo '#!/bin/bash' > $GOPATH/bin/gosec
            echo 'echo "gosec fallback mode - installation failed"' >> $GOPATH/bin/gosec
            echo 'echo "Creating empty results file..."' >> $GOPATH/bin/gosec
            echo 'echo "{\"Stats\":{\"found\":0},\"Issues\":[]}" > gosec-results.json' >> $GOPATH/bin/gosec
            chmod +x $GOPATH/bin/gosec
            echo "‚ö†Ô∏è Created fallback gosec script"
          fi
        fi
        
        # ÊúÄÁªàÈ™åËØÅ
        if command -v gosec &> /dev/null; then
          echo "‚úÖ gosec successfully installed"
          gosec -version
          
          # Ëé∑ÂèñÊâÄÊúâÂåÖÔºåÊéíÈô§Ëá™Âä®ÁîüÊàêÁöÑ‰ª£Á†Å
          PACKAGES=$(go list ./... | grep -v -E '/(api/gen|docs/generated)/')
          
          if [ -z "$PACKAGES" ]; then
            echo "No packages to scan with gosec"
            echo '{"Stats":{"found":0},"Issues":[]}' > gosec-results.json
          else
            echo "Scanning packages with gosec:"
            echo "$PACKAGES"
            
            # ËøêË°å gosec ÂÆâÂÖ®Êâ´ÊèèÔºàÊéíÈô§Ëá™Âä®ÁîüÊàêÁöÑ‰ª£Á†ÅÔºâ
            echo "Running gosec security scan..."
            gosec -fmt json -out gosec-results.json $PACKAGES || true
            gosec $PACKAGES || true
          fi
        else
          echo "‚ùå Failed to install gosec, skipping scan"
          echo '{"Stats":{"found":0},"Issues":[]}' > gosec-results.json
        fi
        
    - name: Display gosec results
      run: |
        echo "üîç Gosec security scan completed"
        if [ -f gosec-results.json ]; then
          echo "üìä Gosec results saved to gosec-results.json"
          # ÁªüËÆ°ÂèëÁé∞ÁöÑÈóÆÈ¢ò
          ISSUES=$(jq '.Stats.found // 0' gosec-results.json 2>/dev/null || echo "0")
          echo "üö® Found $ISSUES potential security issues"
          
          if [ "$ISSUES" -gt 0 ]; then
            echo "‚ö†Ô∏è  Security issues detected. Please review the scan results."
            echo "üìã Summary of issues:"
            jq -r '.Issues[]? | "- \(.severity): \(.details) (Rule: \(.rule_id))"' gosec-results.json 2>/dev/null || echo "Details unavailable"
          else
            echo "‚úÖ No security issues found by gosec"
          fi
        fi
      continue-on-error: true

    - name: Run OSV vulnerability check
      run: |
        echo "üîç Running OSV vulnerability check..."
        mkdir -p _output/security
        go run ./cmd/vuln-checker --fail-on-high=true --fail-on-critical=true || true
      continue-on-error: true
      
    - name: Display OSV vulnerability results
      run: |
        echo "üîç OSV vulnerability check completed"
        if [ -f _output/security/vulnerability-report.json ]; then
          echo "üìä OSV results saved to _output/security/vulnerability-report.json"
          
          # ÁªüËÆ°ÊºèÊ¥û
          TOTAL=$(jq '.summary.total_vulnerabilities // 0' _output/security/vulnerability-report.json 2>/dev/null || echo "0")
          CRITICAL=$(jq '.summary.critical_count // 0' _output/security/vulnerability-report.json 2>/dev/null || echo "0")
          HIGH=$(jq '.summary.high_count // 0' _output/security/vulnerability-report.json 2>/dev/null || echo "0")
          MEDIUM=$(jq '.summary.medium_count // 0' _output/security/vulnerability-report.json 2>/dev/null || echo "0")
          
          echo "üö® Found $TOTAL vulnerabilities: $CRITICAL critical, $HIGH high, $MEDIUM medium"
          
          if [ "$TOTAL" -gt 0 ]; then
            echo "‚ö†Ô∏è  Vulnerabilities detected in dependencies. Please review the report."
            echo "üìã Summary of vulnerabilities:"
            jq -r '.vulnerabilities[]? | "- \(.severity | ascii_upcase): \(.vulnerability_id) in \(.package_name)@\(.installed_version) (Fixed: \(.fixed_version // "N/A"))"' _output/security/vulnerability-report.json 2>/dev/null || echo "Details unavailable"
          else
            echo "‚úÖ No vulnerabilities found in dependencies"
          fi
        else
          echo "‚ö†Ô∏è  Vulnerability report not found"
        fi
      continue-on-error: true
      
    - name: Upload vulnerability reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: vulnerability-reports
        path: |
          _output/security/vulnerability-report.json
          gosec-results.json
          trivy-results.json
        retention-days: 30
      continue-on-error: true
