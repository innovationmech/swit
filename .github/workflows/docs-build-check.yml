name: ğŸ“ Documentation Build Check

on:
  pull_request:
    branches: [master]
    paths:
      - 'docs/pages/**'
      - '.github/workflows/docs-build-check.yml'
    types: [opened, synchronize, reopened]

# è®¾ç½®æƒé™
permissions:
  contents: read
  pull-requests: write
  checks: write

# å…è®¸ä¸€ä¸ªå¹¶å‘æ£€æŸ¥ï¼ˆæŒ‰ PR åˆ†ç»„ï¼‰
concurrency:
  group: "docs-build-check-${{ github.event.number }}"
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  DOCS_DIR: './docs/pages'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  lint-check:
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    outputs:
      lint-success: ${{ steps.lint.outputs.success }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.DOCS_DIR }}/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          npm ci
          echo "ğŸ“¦ Dependencies installed for lint check"

      - name: ğŸ” ESLint check
        id: lint
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ğŸ” Running ESLint check..."
          
          if npm run lint:check; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… ESLint check passed"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ ESLint check failed"
            exit 1
          fi

      - name: ğŸ” TypeScript type check
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ğŸ” Running TypeScript type check..."
          
          if [ -f "tsconfig.json" ]; then
            if npx vue-tsc --noEmit; then
              echo "âœ… TypeScript check passed"
            else
              echo "âŒ TypeScript check failed"
              exit 1
            fi
          else
            echo "âš ï¸ No tsconfig.json found, skipping TypeScript check"
          fi

  # æ„å»ºæµ‹è¯•
  build-check:
    runs-on: ubuntu-latest
    needs: lint-check
    if: needs.lint-check.outputs.lint-success == 'true'
    outputs:
      build-success: ${{ steps.build.outputs.success }}
      build-size: ${{ steps.analyze.outputs.size }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.DOCS_DIR }}/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: npm ci

      - name: ğŸ”§ Configure build environment
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ğŸ”§ Configuring build environment..."
          
          # è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡
          echo "NODE_ENV=test" >> $GITHUB_ENV
          echo "VITE_BUILD_TIME=$(date -u)" >> $GITHUB_ENV
          echo "VITE_COMMIT_SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV
          echo "VITE_COMMIT_REF=${{ github.head_ref }}" >> $GITHUB_ENV
          echo "VITE_PR_NUMBER=${{ github.event.number }}" >> $GITHUB_ENV
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ ! -f ".vitepress/config.mjs" ]; then
            echo "âŒ VitePress config file not found"
            exit 1
          fi

      - name: ğŸ—ï¸ Build documentation
        id: build
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ğŸ—ï¸ Building documentation..."
          
          if npm run build; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Documentation built successfully"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ Documentation build failed"
            exit 1
          fi
          
          # éªŒè¯æ„å»ºè¾“å‡º
          if [ ! -d "dist" ]; then
            echo "âŒ Build output directory not found"
            exit 1
          fi
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Main index.html not found in build output"
            exit 1
          fi

      - name: ğŸ“Š Analyze build size
        id: analyze
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ğŸ“Š Analyzing build size..."
          
          # è®¡ç®—æ„å»ºå¤§å°
          DIST_SIZE=$(du -sh dist | cut -f1)
          DIST_SIZE_KB=$(du -s dist | cut -f1)
          
          echo "size=${DIST_SIZE}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Build size: ${DIST_SIZE}"
          
          # æ£€æŸ¥åŒ…å¤§å°é™åˆ¶ï¼ˆ50MBï¼‰
          MAX_SIZE=51200  # 50MB in KB
          
          if [ $DIST_SIZE_KB -gt $MAX_SIZE ]; then
            echo "âš ï¸ Build size ($DIST_SIZE) exceeds recommended limit (50MB)"
            echo "Consider optimizing assets or splitting content"
          else
            echo "âœ… Build size within limits"
          fi
          
          # æ˜¾ç¤ºæœ€å¤§çš„æ–‡ä»¶
          echo "ğŸ” Largest files:"
          find dist -type f -exec du -h {} \; | sort -hr | head -10

  # å†…å®¹éªŒè¯
  content-validation:
    runs-on: ubuntu-latest
    needs: build-check
    if: needs.build-check.outputs.build-success == 'true'
    outputs:
      validation-success: ${{ steps.validate.outputs.success }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.DOCS_DIR }}/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        working-directory: ${{ env.DOCS_DIR }}
        run: npm ci

      - name: ğŸ” Validate content
        id: validate
        working-directory: ${{ env.DOCS_DIR }}
        run: |
          echo "ğŸ” Validating documentation content..."
          
          # è¿è¡Œå†…å®¹éªŒè¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if npm run validate:content --if-present; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… Content validation passed"
          else
            echo "success=true" >> $GITHUB_OUTPUT  # éé˜»å¡
            echo "âš ï¸ Content validation not available or failed (non-blocking)"
          fi
          
          # æ£€æŸ¥é“¾æ¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if npm run validate:links --if-present; then
            echo "âœ… Link validation passed"
          else
            echo "âš ï¸ Link validation not available"
          fi

  # åˆ†æå˜æ›´
  analyze-changes:
    runs-on: ubuntu-latest
    outputs:
      total-changes: ${{ steps.changes.outputs.total }}
      markdown-changes: ${{ steps.changes.outputs.markdown }}
      vue-changes: ${{ steps.changes.outputs.vue }}
      config-changes: ${{ steps.changes.outputs.config }}
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Analyze changes
        id: changes
        run: |
          echo "ğŸ” Analyzing documentation changes..."
          
          # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          git diff --name-only origin/master...HEAD -- docs/pages/ > changed_files.txt
          
          if [ -s changed_files.txt ]; then
            echo "ğŸ“ Changed files:"
            cat changed_files.txt
            
            # ç»Ÿè®¡å˜æ›´ï¼ˆé¿å… grep -c å¤±è´¥æ—¶è¾“å‡ºé¢å¤–çš„ 0 è¡Œå¯¼è‡´ GITHUB_OUTPUT è§£æé”™è¯¯ï¼‰
            TOTAL_CHANGES=$(wc -l < changed_files.txt)
            # ä½¿ç”¨ grep | wc -lï¼Œå¦‚æœæ²¡æœ‰åŒ¹é… grep é€€å‡ºç ä¸º 1 ä½†ä¸ä¼šè¾“å‡ºå†…å®¹ï¼Œä¸ä¼šäº§ç”Ÿå­¤ç«‹çš„ "0" è¡Œ
            MD_CHANGES=$(grep '\.md$' changed_files.txt | wc -l || echo 0)
            VUE_CHANGES=$(grep '\.vue$' changed_files.txt | wc -l || echo 0)
            CONFIG_CHANGES=$(grep -E 'config|\.(json|yaml|yml)$' changed_files.txt | wc -l || echo 0)
            
            echo "total=${TOTAL_CHANGES}" >> $GITHUB_OUTPUT
            echo "markdown=${MD_CHANGES}" >> $GITHUB_OUTPUT
            echo "vue=${VUE_CHANGES}" >> $GITHUB_OUTPUT
            echo "config=${CONFIG_CHANGES}" >> $GITHUB_OUTPUT
            
            echo "ğŸ“Š Change summary:"
            echo "  Total files: $TOTAL_CHANGES"
            echo "  Markdown files: $MD_CHANGES"
            echo "  Vue components: $VUE_CHANGES"
            echo "  Config files: $CONFIG_CHANGES"
          else
            echo "ğŸ“ No documentation files changed"
            echo "total=0" >> $GITHUB_OUTPUT
            echo "markdown=0" >> $GITHUB_OUTPUT
            echo "vue=0" >> $GITHUB_OUTPUT
            echo "config=0" >> $GITHUB_OUTPUT
          fi

  # æ›´æ–° PR çŠ¶æ€
  update-pr-status:
    runs-on: ubuntu-latest
    needs: [lint-check, build-check, content-validation, analyze-changes]
    if: always()
    permissions:
      pull-requests: write
    steps:
      - name: ğŸ’¬ Update PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const lintSuccess = '${{ needs.lint-check.outputs.lint-success }}' === 'true';
            const buildSuccess = '${{ needs.build-check.outputs.build-success }}' === 'true';
            const validationSuccess = '${{ needs.content-validation.outputs.validation-success }}' === 'true';
            const buildSize = '${{ needs.build-check.outputs.build-size }}' || 'Unknown';
            
            const totalChanges = parseInt('${{ needs.analyze-changes.outputs.total-changes }}') || 0;
            const markdownChanges = parseInt('${{ needs.analyze-changes.outputs.markdown-changes }}') || 0;
            const vueChanges = parseInt('${{ needs.analyze-changes.outputs.vue-changes }}') || 0;
            const configChanges = parseInt('${{ needs.analyze-changes.outputs.config-changes }}') || 0;
            
            let commentBody = `## ğŸ“ Documentation Build Check\n\n`;
            
            // æ£€æŸ¥çŠ¶æ€
            commentBody += `### ğŸ§ª Check Results\n`;
            commentBody += `- **Lint Check**: ${lintSuccess ? 'âœ… Passed' : 'âŒ Failed'}\n`;
            commentBody += `- **Build Check**: ${buildSuccess ? 'âœ… Passed' : 'âŒ Failed'}\n`;
            commentBody += `- **Content Validation**: ${validationSuccess ? 'âœ… Passed' : 'âš ï¸ Warning'}\n`;
            
            if (buildSuccess) {
              commentBody += `- **Build Size**: ${buildSize}\n`;
            }
            commentBody += `\n`;
            
            // å˜æ›´æ‘˜è¦
            if (totalChanges > 0) {
              commentBody += `### ğŸ“Š Changes Summary\n`;
              commentBody += `- **Total files changed**: ${totalChanges}\n`;
              if (markdownChanges > 0) {
                commentBody += `- **Markdown files**: ${markdownChanges}\n`;
              }
              if (vueChanges > 0) {
                commentBody += `- **Vue components**: ${vueChanges}\n`;
              }
              if (configChanges > 0) {
                commentBody += `- **Config files**: ${configChanges}\n`;
              }
              commentBody += `\n`;
            }
            
            // å¿«é€Ÿæ“ä½œ
            commentBody += `### ğŸ” Quick Actions\n`;
            commentBody += `- [View diff](${context.payload.pull_request.html_url}/files)\n`;
            commentBody += `- [CI logs](${context.payload.pull_request.html_url}/checks)\n`;
            
            // çŠ¶æ€æç¤º
            if (lintSuccess && buildSuccess) {
              commentBody += `\nâœ… **All checks passed!** This PR is ready for review.\n`;
            } else {
              commentBody += `\nâŒ **Some checks failed.** Please review the errors above.\n`;
            }
            
            commentBody += `\n---\n`;
            commentBody += `*Build check completed at ${new Date().toUTCString()}*\n`;
            commentBody += `*Commit: ${context.payload.pull_request.head.sha.substring(0, 7)}*`;
            
            // æŸ¥æ‰¾ç°æœ‰è¯„è®º
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ“ Documentation Build Check')
            );
            
            if (botComment) {
              // æ›´æ–°ç°æœ‰è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }